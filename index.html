<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPATDA - Sistem Informasi Manajemen Pajak Daerah Kabupaten Sidrap</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Shapefile JS for SHP -->
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <!-- JSZip for KMZ -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- toGeoJSON for KML -->
    <script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>
    <!-- Tax Form Definitions -->
    <script src="tax-forms.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .modal { transition: opacity 0.3s ease; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 4px solid #60a5fa; }
        .table-row:hover { background: #f8fafc; }
        input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        .animate-fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .login-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .logo-shadow {
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s ease-in-out infinite; }
        .login-input {
            transition: all 0.3s ease;
        }
        .login-input:focus {
            transform: translateY(-2px);
        }
        #mapContainer, #blockMapContainer {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }
        #blockMapContainer {
            height: 600px;
        }
        .leaflet-container {
            border-radius: 8px;
        }
        .coord-input-group {
            position: relative;
        }
        .map-btn {
            transition: all 0.2s ease;
        }
        .map-btn:hover {
            transform: scale(1.05);
        }
        .location-preview {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
        }
        .file-drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .layer-item {
            transition: all 0.2s ease;
        }
        .layer-item:hover {
            background: #f1f5f9;
        }
        .layer-color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Page -->
    <div id="loginPage" class="login-bg flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <!-- Logo and Header -->
            <div class="text-center mb-8 animate-fade-in">
                <div class="inline-block p-4 bg-white rounded-full shadow-xl mb-4 logo-shadow">
                    <!-- Logo Kabupaten Sidrap -->
                    <svg width="100" height="100" viewBox="0 0 200 200" class="animate-pulse-slow">
                        <!-- Background Circle -->
                        <circle cx="100" cy="100" r="95" fill="#1e3a8a" stroke="#fbbf24" stroke-width="3"/>
                        
                        <!-- Shield Shape -->
                        <path d="M100 25 L160 50 L160 110 Q160 160 100 185 Q40 160 40 110 L40 50 Z" 
                              fill="#1e40af" stroke="#fbbf24" stroke-width="2"/>
                        
                        <!-- Rice stalks (Padi) - Left -->
                        <g fill="#22c55e">
                            <ellipse cx="60" cy="70" rx="4" ry="8" transform="rotate(-30 60 70)"/>
                            <ellipse cx="55" cy="80" rx="4" ry="8" transform="rotate(-40 55 80)"/>
                            <ellipse cx="52" cy="92" rx="4" ry="8" transform="rotate(-50 52 92)"/>
                            <ellipse cx="50" cy="105" rx="4" ry="8" transform="rotate(-55 50 105)"/>
                            <path d="M65 65 Q50 100 55 130" stroke="#15803d" stroke-width="2" fill="none"/>
                        </g>
                        
                        <!-- Rice stalks (Padi) - Right -->
                        <g fill="#22c55e">
                            <ellipse cx="140" cy="70" rx="4" ry="8" transform="rotate(30 140 70)"/>
                            <ellipse cx="145" cy="80" rx="4" ry="8" transform="rotate(40 145 80)"/>
                            <ellipse cx="148" cy="92" rx="4" ry="8" transform="rotate(50 148 92)"/>
                            <ellipse cx="150" cy="105" rx="4" ry="8" transform="rotate(55 150 105)"/>
                            <path d="M135 65 Q150 100 145 130" stroke="#15803d" stroke-width="2" fill="none"/>
                        </g>
                        
                        <!-- Cotton (Kapas) - Left -->
                        <g fill="white" stroke="#d1d5db" stroke-width="1">
                            <circle cx="55" cy="140" r="6"/>
                            <circle cx="48" cy="148" r="5"/>
                            <circle cx="62" cy="150" r="5"/>
                            <circle cx="52" cy="155" r="4"/>
                        </g>
                        
                        <!-- Cotton (Kapas) - Right -->
                        <g fill="white" stroke="#d1d5db" stroke-width="1">
                            <circle cx="145" cy="140" r="6"/>
                            <circle cx="152" cy="148" r="5"/>
                            <circle cx="138" cy="150" r="5"/>
                            <circle cx="148" cy="155" r="4"/>
                        </g>
                        
                        <!-- Star (Bintang) -->
                        <polygon points="100,40 104,52 117,52 107,60 111,73 100,65 89,73 93,60 83,52 96,52" 
                                 fill="#fbbf24" stroke="#f59e0b" stroke-width="1"/>
                        
                        <!-- Buffalo Head (Kerbau) - Simplified -->
                        <g fill="#374151">
                            <!-- Head -->
                            <ellipse cx="100" cy="105" rx="25" ry="20"/>
                            <!-- Horns -->
                            <path d="M75 95 Q60 80 55 95" stroke="#374151" stroke-width="6" fill="none" stroke-linecap="round"/>
                            <path d="M125 95 Q140 80 145 95" stroke="#374151" stroke-width="6" fill="none" stroke-linecap="round"/>
                            <!-- Eyes -->
                            <circle cx="90" cy="100" r="3" fill="white"/>
                            <circle cx="110" cy="100" r="3" fill="white"/>
                            <circle cx="90" cy="100" r="1.5" fill="#1e3a8a"/>
                            <circle cx="110" cy="100" r="1.5" fill="#1e3a8a"/>
                            <!-- Nose -->
                            <ellipse cx="100" cy="115" rx="10" ry="6" fill="#4b5563"/>
                            <circle cx="96" cy="115" r="2" fill="#1f2937"/>
                            <circle cx="104" cy="115" r="2" fill="#1f2937"/>
                        </g>
                        
                        <!-- Text SIDRAP -->
                        <text x="100" cy="170" text-anchor="middle" y="145" font-size="10" font-weight="bold" fill="#fbbf24">SIDENRENG</text>
                        <text x="100" cy="180" text-anchor="middle" y="158" font-size="10" font-weight="bold" fill="#fbbf24">RAPPANG</text>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">SIMPATDA</h1>
                <p class="text-blue-200 text-sm">Sistem Informasi Manajemen Pajak Daerah</p>
                <p class="text-blue-300 text-xs mt-1">Kabupaten Sidenreng Rappang</p>
            </div>

            <!-- Login Card -->
            <div class="glass-card rounded-2xl p-8 animate-fade-in">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Masuk ke Sistem</h2>
                    <p class="text-gray-500 text-sm mt-1">Silakan masukkan kredensial Anda</p>
                </div>

                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-blue-600"></i>Username
                        </label>
                        <input type="text" id="username" required 
                            class="login-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500"
                            placeholder="Masukkan username">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock mr-2 text-blue-600"></i>Password
                        </label>
                        <div class="relative">
                            <input type="password" id="password" required 
                                class="login-input w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500"
                                placeholder="Masukkan password">
                            <button type="button" onclick="togglePassword()" class="absolute right-4 top-3.5 text-gray-400 hover:text-gray-600">
                                <i class="fas fa-eye" id="toggleIcon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-6">
                        <label class="flex items-center text-sm text-gray-600">
                            <input type="checkbox" id="rememberMe" class="mr-2 rounded border-gray-300">
                            Ingat saya
                        </label>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800">Lupa password?</a>
                    </div>

                    <button type="submit" 
                        class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-900 transition-all duration-300 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
                        <i class="fas fa-sign-in-alt"></i>
                        Masuk
                    </button>
                </form>

                <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg text-sm text-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="errorMessage">Username atau password salah</span>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="text-center text-xs text-gray-500">
                        <p class="mb-2">Default Login:</p>
                        <p><strong>Admin:</strong> admin / admin123</p>
                        <p><strong>Operator:</strong> operator / operator123</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-6 text-blue-200 text-xs">
                <p>© 2024 Badan Pendapatan Daerah Kabupaten Sidrap</p>
                <p class="mt-1">UU No. 1 Tahun 2022 tentang HKPD & PP No. 35 Tahun 2024</p>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden by default) -->
    <div id="mainApp" class="hidden">
        <div class="flex min-h-screen">
            <!-- Sidebar -->
            <aside class="w-64 gradient-bg text-white fixed h-full overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-2">
                        <!-- Mini Logo -->
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                            <svg width="30" height="30" viewBox="0 0 200 200">
                                <circle cx="100" cy="100" r="95" fill="#1e3a8a"/>
                                <polygon points="100,40 104,52 117,52 107,60 111,73 100,65 89,73 93,60 83,52 96,52" fill="#fbbf24"/>
                                <ellipse cx="100" cy="105" rx="20" ry="15" fill="#374151"/>
                                <path d="M80 98 Q68 85 63 95" stroke="#374151" stroke-width="4" fill="none" stroke-linecap="round"/>
                                <path d="M120 98 Q132 85 137 95" stroke="#374151" stroke-width="4" fill="none" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold">SIMPATDA</h1>
                            <p class="text-xs text-blue-200">Kab. Sidrap v1.0</p>
                        </div>
                    </div>
                    <p class="text-xs text-blue-200 mt-2">UU 1/2022 & PP 35/2024</p>
                </div>
                
                <nav class="mt-4">
                    <div class="px-4 py-2 text-xs text-blue-300 uppercase tracking-wider">Menu Utama</div>
                    <a href="#" onclick="showSection('dashboard')" class="sidebar-item active flex items-center gap-3 px-6 py-3 cursor-pointer" id="nav-dashboard">
                        <i class="fas fa-tachometer-alt w-5"></i> Dashboard
                    </a>
                    <a href="#" onclick="showSection('input')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer" id="nav-input">
                        <i class="fas fa-user-plus w-5"></i> Input Wajib Pajak
                    </a>
                    <a href="#" onclick="showSection('data')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer" id="nav-data">
                        <i class="fas fa-database w-5"></i> Data Wajib Pajak
                    </a>
                    <a href="#" onclick="showSection('petablok')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer" id="nav-petablok">
                        <i class="fas fa-map w-5"></i> Peta Blok
                    </a>
                    <a href="#" onclick="showSection('realisasi')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer" id="nav-realisasi">
                        <i class="fas fa-chart-bar w-5"></i> Realisasi Pajak
                    </a>
                    
                    <div class="px-4 py-2 mt-4 text-xs text-blue-300 uppercase tracking-wider">Jenis Pajak</div>
                    <a href="#" onclick="filterByTax('all')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-list w-5"></i> Semua Pajak
                    </a>
                    <a href="#" onclick="filterByTax('reklame')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-ad w-5"></i> Pajak Reklame
                    </a>
                    <a href="#" onclick="filterByTax('air_tanah')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-tint w-5"></i> Pajak Air Tanah
                    </a>
                    <a href="#" onclick="filterByTax('sarang_walet')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-dove w-5"></i> Pajak Sarang Walet
                    </a>
                    <a href="#" onclick="filterByTax('mineral')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-gem w-5"></i> Pajak Mineral
                    </a>
                    <a href="#" onclick="filterByTax('pbb')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-home w-5"></i> PBB-P2
                    </a>
                    <a href="#" onclick="filterByTax('bphtb')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-file-contract w-5"></i> BPHTB
                    </a>
                    <a href="#" onclick="filterByTax('pbjt_makanan')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-utensils w-5"></i> PBJT Makanan
                    </a>
                    <a href="#" onclick="filterByTax('pbjt_listrik')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-bolt w-5"></i> PBJT Listrik
                    </a>
                    <a href="#" onclick="filterByTax('pbjt_hotel')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-hotel w-5"></i> PBJT Perhotelan
                    </a>
                    <a href="#" onclick="filterByTax('pbjt_parkir')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-parking w-5"></i> PBJT Parkir
                    </a>
                    <a href="#" onclick="filterByTax('pbjt_hiburan')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-theater-masks w-5"></i> PBJT Hiburan
                    </a>
                    <a href="#" onclick="filterByTax('opsen_pkb')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-car w-5"></i> Opsen PKB
                    </a>
                    <a href="#" onclick="filterByTax('opsen_bbnkb')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm">
                        <i class="fas fa-exchange-alt w-5"></i> Opsen BBNKB
                    </a>

                    <div class="px-4 py-2 mt-4 text-xs text-blue-300 uppercase tracking-wider">Pengaturan</div>
                    <a href="#" onclick="showSection('users')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm" id="nav-users">
                        <i class="fas fa-users-cog w-5"></i> Manajemen User
                    </a>
                    <a href="#" onclick="showSection('firebase')" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm" id="nav-firebase">
                        <i class="fas fa-cloud w-5"></i> Pengaturan Cloud
                    </a>
                    <a href="#" onclick="handleLogout()" class="sidebar-item flex items-center gap-3 px-6 py-3 cursor-pointer text-sm text-red-300 hover:text-red-200">
                        <i class="fas fa-sign-out-alt w-5"></i> Logout
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 ml-64">
                <!-- Header -->
                <header class="bg-white shadow-sm sticky top-0 z-10">
                    <div class="flex items-center justify-between px-8 py-4">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800" id="page-title">Dashboard</h2>
                            <p class="text-sm text-gray-500">Selamat datang di Sistem Informasi Manajemen Pajak Daerah Kabupaten Sidrap</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <input type="text" id="globalSearch" placeholder="Cari wajib pajak..." 
                                    class="pl-10 pr-4 py-2 border rounded-lg w-64 focus:border-blue-500" onkeyup="globalSearchWP()">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <div class="flex items-center gap-3 bg-gray-100 px-4 py-2 rounded-lg">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm" id="userAvatar">A</div>
                                <div>
                                    <p class="text-sm font-medium" id="userName">Administrator</p>
                                    <p class="text-xs text-gray-500" id="userRole">Admin</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Dashboard Section -->
                <section id="section-dashboard" class="p-8 animate-fade-in">
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-6 mb-8 text-white">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                                <svg width="40" height="40" viewBox="0 0 200 200">
                                    <circle cx="100" cy="100" r="95" fill="rgba(255,255,255,0.2)"/>
                                    <polygon points="100,40 104,52 117,52 107,60 111,73 100,65 89,73 93,60 83,52 96,52" fill="#fbbf24"/>
                                    <ellipse cx="100" cy="105" rx="20" ry="15" fill="white"/>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold">Selamat Datang di SIMPATDA</h2>
                                <p class="text-blue-100">Badan Pendapatan Daerah Kabupaten Sidenreng Rappang</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Wajib Pajak</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="stat-total">0</h3>
                                </div>
                                <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">WP Badan Usaha</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="stat-badan">0</h3>
                                </div>
                                <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-building text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">WP Orang Pribadi</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="stat-pribadi">0</h3>
                                </div>
                                <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-orange-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Layer Peta</p>
                                    <h3 class="text-3xl font-bold text-gray-800" id="stat-layers">0</h3>
                                </div>
                                <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-layer-group text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Type Cards -->
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Statistik Per Jenis Pajak</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8" id="tax-stats-grid">
                        <!-- Dynamically populated -->
                    </div>

                    <!-- Recent Entries -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Wajib Pajak Terbaru</h3>
                            <button onclick="showSection('data')" class="text-blue-600 hover:text-blue-800 text-sm">Lihat Semua →</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NPWPD</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Pajak</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal Daftar</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-table">
                                    <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Belum ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Peta Blok Section -->
                <section id="section-petablok" class="p-8 hidden animate-fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Left Panel - Controls -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Import Panel -->
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-upload text-blue-600"></i> Import Data Spasial
                                </h3>
                                
                                <div id="fileDropZone" class="file-drop-zone rounded-lg p-6 text-center cursor-pointer mb-4"
                                     onclick="document.getElementById('fileInput').click()"
                                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                                    <input type="file" id="fileInput" accept=".shp,.zip,.kmz,.kml" class="hidden" onchange="handleFileSelect(event)" multiple>
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                    <p class="text-sm text-gray-600 font-medium">Drag & Drop file atau klik untuk upload</p>
                                    <p class="text-xs text-gray-400 mt-2">Format: SHP (ZIP), KMZ, KML</p>
                                </div>

                                <div class="space-y-2">
                                    <button onclick="document.getElementById('shpInput').click()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 text-sm">
                                        <i class="fas fa-file-archive"></i> Import SHP/ZIP
                                    </button>
                                    <input type="file" id="shpInput" accept=".zip,.shp" class="hidden" onchange="importSHP(event)">
                                    
                                    <button onclick="document.getElementById('kmzInput').click()" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 flex items-center justify-center gap-2 text-sm">
                                        <i class="fas fa-globe"></i> Import KMZ/KML
                                    </button>
                                    <input type="file" id="kmzInput" accept=".kmz,.kml" class="hidden" onchange="importKMZ(event)">
                                </div>

                                <div id="importStatus" class="hidden mt-4 p-3 rounded-lg text-sm">
                                    <!-- Import status messages -->
                                </div>
                            </div>

                            <!-- Layer List -->
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                        <i class="fas fa-layer-group text-blue-600"></i> Daftar Layer
                                    </h3>
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full" id="layerCount">0 layer</span>
                                </div>
                                
                                <div id="layerList" class="space-y-2 max-h-80 overflow-y-auto">
                                    <p class="text-sm text-gray-500 text-center py-4">Belum ada layer</p>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t flex gap-2">
                                    <button onclick="clearAllLayers()" class="flex-1 px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-sm flex items-center justify-center gap-1">
                                        <i class="fas fa-trash"></i> Hapus Semua
                                    </button>
                                    <button onclick="fitToAllLayers()" class="flex-1 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm flex items-center justify-center gap-1">
                                        <i class="fas fa-expand"></i> Fit All
                                    </button>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-palette text-blue-600"></i> Legenda
                                </h3>
                                <div id="legendContainer" class="space-y-1">
                                    <p class="text-sm text-gray-500 text-center py-2">Tidak ada legenda</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel - Map -->
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                        <i class="fas fa-map-marked-alt text-blue-600"></i> Peta Blok Pajak
                                    </h3>
                                    <div class="flex gap-2">
                                        <button onclick="toggleWPMarkers()" id="btnToggleWP" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm flex items-center gap-1">
                                            <i class="fas fa-map-marker-alt"></i> Tampilkan WP
                                        </button>
                                        <select id="baseMapSelector" onchange="changeBaseMap()" class="px-3 py-2 border rounded-lg text-sm">
                                            <option value="osm">OpenStreetMap</option>
                                            <option value="satellite">Satelit</option>
                                            <option value="terrain">Terrain</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="blockMapContainer" class="rounded-lg border"></div>
                                
                                <!-- Feature Info Panel -->
                                <div id="featureInfoPanel" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-800 flex items-center gap-2">
                                            <i class="fas fa-info-circle text-blue-600"></i> Informasi Fitur
                                        </h4>
                                        <button onclick="closeFeatureInfo()" class="text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div id="featureInfoContent" class="text-sm">
                                        <!-- Feature info will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Input Section -->
                <section id="section-input" class="p-8 hidden animate-fade-in">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="border-b pb-4 mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">Formulir Pendaftaran Wajib Pajak Daerah</h3>
                            <p class="text-sm text-gray-500 mt-1">Berdasarkan UU No. 1 Tahun 2022 tentang HKPD dan PP No. 35 Tahun 2024</p>
                        </div>

                        <form id="wpForm" onsubmit="saveWajibPajak(event)">
                            <!-- Data Umum WP -->
                            <div class="mb-8">
                                <h4 class="text-md font-semibold text-gray-700 mb-4 flex items-center gap-2">
                                    <i class="fas fa-user-circle text-blue-600"></i> Data Umum Wajib Pajak
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NPWPD <span class="text-red-500">*</span></label>
                                        <input type="text" id="npwpd" required placeholder="Auto Generate" readonly
                                            class="w-full px-4 py-2 border rounded-lg bg-gray-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Wajib Pajak <span class="text-red-500">*</span></label>
                                        <select id="jenisWP" required class="w-full px-4 py-2 border rounded-lg" onchange="toggleJenisWP()">
                                            <option value="">Pilih Jenis WP</option>
                                            <option value="pribadi">Orang Pribadi</option>
                                            <option value="badan">Badan Usaha</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NIK/NPWP <span class="text-red-500">*</span></label>
                                        <input type="text" id="nikNpwp" required placeholder="Masukkan NIK/NPWP"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Wajib Pajak <span class="text-red-500">*</span></label>
                                        <input type="text" id="namaWP" required placeholder="Nama Lengkap/Badan Usaha"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div id="field-nama-usaha" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Usaha</label>
                                        <input type="text" id="namaUsaha" placeholder="Nama Usaha/Perusahaan"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">No. Telepon <span class="text-red-500">*</span></label>
                                        <input type="tel" id="telepon" required placeholder="08xxxxxxxxxx"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="email" placeholder="email@example.com"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <!-- Alamat WP -->
                            <div class="mb-8">
                                <h4 class="text-md font-semibold text-gray-700 mb-4 flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-blue-600"></i> Alamat Wajib Pajak
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Lengkap <span class="text-red-500">*</span></label>
                                        <textarea id="alamat" required rows="2" placeholder="Jalan, Nomor, RT/RW"
                                            class="w-full px-4 py-2 border rounded-lg"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kelurahan/Desa <span class="text-red-500">*</span></label>
                                        <input type="text" id="kelurahan" required placeholder="Kelurahan/Desa"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kecamatan <span class="text-red-500">*</span></label>
                                        <select id="kecamatan" required class="w-full px-4 py-2 border rounded-lg">
                                            <option value="">Pilih Kecamatan</option>
                                            <option value="Baranti">Baranti</option>
                                            <option value="Dua Pitue">Dua Pitue</option>
                                            <option value="Kulo">Kulo</option>
                                            <option value="Maritengngae">Maritengngae</option>
                                            <option value="Panca Lautang">Panca Lautang</option>
                                            <option value="Panca Rijang">Panca Rijang</option>
                                            <option value="Pitu Riase">Pitu Riase</option>
                                            <option value="Pitu Riawa">Pitu Riawa</option>
                                            <option value="Tellu Limpoe">Tellu Limpoe</option>
                                            <option value="Watang Pulu">Watang Pulu</option>
                                            <option value="Watang Sidenreng">Watang Sidenreng</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kabupaten/Kota</label>
                                        <input type="text" id="kabupaten" value="Sidenreng Rappang" readonly
                                            class="w-full px-4 py-2 border rounded-lg bg-gray-100">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label>
                                        <input type="text" id="kodePos" placeholder="Kode Pos"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <!-- Jenis Pajak -->
                            <div class="mb-8">
                                <h4 class="text-md font-semibold text-gray-700 mb-4 flex items-center gap-2">
                                    <i class="fas fa-file-invoice-dollar text-blue-600"></i> Jenis Pajak Daerah
                                </h4>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Jenis Pajak <span class="text-red-500">*</span></label>
                                    <select id="jenisPajak" required class="w-full px-4 py-2 border rounded-lg" onchange="showTaxFields()">
                                        <option value="">Pilih Jenis Pajak</option>
                                        <optgroup label="Pajak Daerah">
                                            <option value="reklame">Pajak Reklame</option>
                                            <option value="air_tanah">Pajak Air Tanah</option>
                                            <option value="sarang_walet">Pajak Sarang Burung Walet</option>
                                            <option value="mineral">Pajak Mineral Bukan Logam dan Batuan</option>
                                            <option value="pbb">Pajak Bumi dan Bangunan Perdesaan dan Perkotaan (PBB-P2)</option>
                                            <option value="bphtb">Bea Perolehan Hak atas Tanah dan Bangunan (BPHTB)</option>
                                        </optgroup>
                                        <optgroup label="Pajak Barang dan Jasa Tertentu (PBJT)">
                                            <option value="pbjt_makanan">PBJT - Makanan dan/atau Minuman</option>
                                            <option value="pbjt_listrik">PBJT - Tenaga Listrik</option>
                                            <option value="pbjt_hotel">PBJT - Jasa Perhotelan</option>
                                            <option value="pbjt_parkir">PBJT - Jasa Parkir</option>
                                            <option value="pbjt_hiburan">PBJT - Jasa Kesenian dan Hiburan</option>
                                        </optgroup>
                                        <optgroup label="Opsen Pajak">
                                            <option value="opsen_pkb">Opsen Pajak Kendaraan Bermotor (PKB)</option>
                                            <option value="opsen_bbnkb">Opsen Bea Balik Nama Kendaraan Bermotor (BBNKB)</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>

                            <!-- Dynamic Tax Fields Container -->
                            <div id="taxFieldsContainer" class="mb-8 hidden">
                                <!-- Tax specific fields will be injected here -->
                            </div>

                            <!-- Submit Buttons -->
                            <div class="flex gap-4 pt-4 border-t">
                                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                    <i class="fas fa-save"></i> Simpan Data
                                </button>
                                <button type="button" onclick="resetForm()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center gap-2">
                                    <i class="fas fa-redo"></i> Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Users Section -->
                <section id="section-users" class="p-8 hidden animate-fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- User Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <div class="border-b pb-4 mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800" id="userFormTitle">Tambah User Baru</h3>
                                    <p class="text-sm text-gray-500 mt-1">Isi form untuk menambah user</p>
                                </div>
                                
                                <form id="userForm" onsubmit="saveUser(event)">
                                    <input type="hidden" id="editUserId" value="">
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap <span class="text-red-500">*</span></label>
                                        <input type="text" id="userFullName" required placeholder="Masukkan nama lengkap"
                                            class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Username <span class="text-red-500">*</span></label>
                                        <input type="text" id="userUsername" required placeholder="Masukkan username"
                                            class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="userEmail" placeholder="email@example.com"
                                            class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Password <span class="text-red-500">*</span></label>
                                        <div class="relative">
                                            <input type="password" id="userPassword" placeholder="Masukkan password"
                                                class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                            <button type="button" onclick="toggleUserPassword()" class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-eye" id="toggleUserPwIcon"></i>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1" id="passwordHint">Minimal 6 karakter</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Role <span class="text-red-500">*</span></label>
                                        <select id="userRole2" required class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                            <option value="">Pilih Role</option>
                                            <option value="Admin">Admin</option>
                                            <option value="Operator">Operator</option>
                                            <option value="Viewer">Viewer</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select id="userStatus" class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                            <option value="active">Aktif</option>
                                            <option value="inactive">Tidak Aktif</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">No. Telepon</label>
                                        <input type="tel" id="userPhone" placeholder="08xxxxxxxxxx"
                                            class="w-full px-4 py-2 border rounded-lg focus:border-blue-500">
                                    </div>
                                    
                                    <div class="flex gap-2 pt-4 border-t">
                                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                            <i class="fas fa-save"></i> <span id="userFormBtn">Simpan</span>
                                        </button>
                                        <button type="button" onclick="resetUserForm()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- User List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800">Daftar User</h3>
                                        <p class="text-sm text-gray-500" id="userCount">Total: 0 user</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="searchUser" placeholder="Cari user..." 
                                            class="px-4 py-2 border rounded-lg" onkeyup="filterUsers()">
                                        <select id="filterRole" onchange="filterUsers()" class="px-4 py-2 border rounded-lg">
                                            <option value="">Semua Role</option>
                                            <option value="Admin">Admin</option>
                                            <option value="Operator">Operator</option>
                                            <option value="Viewer">Viewer</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="w-full" id="userTable">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="userTableBody">
                                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Firebase/Cloud Section -->
                <section id="section-firebase" class="p-8 hidden animate-fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Firebase Configuration -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="border-b pb-4 mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-cloud text-blue-600"></i> Konfigurasi Firebase
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">Hubungkan aplikasi dengan Firebase Realtime Database untuk penyimpanan online</p>
                            </div>
                            
                            <div id="firebaseStatus" class="mb-6 p-4 rounded-lg bg-gray-100">
                                <div class="flex items-center gap-3">
                                    <div id="statusIcon" class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                                        <i class="fas fa-cloud-upload-alt text-gray-500"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium" id="statusText">Belum Terhubung</p>
                                        <p class="text-sm text-gray-500" id="statusDesc">Konfigurasi Firebase untuk menyimpan data secara online</p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="firebaseConfigForm" onsubmit="saveFirebaseConfig(event)">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key <span class="text-red-500">*</span></label>
                                    <input type="text" id="fbApiKey" required placeholder="AIzaSy..."
                                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Auth Domain <span class="text-red-500">*</span></label>
                                    <input type="text" id="fbAuthDomain" required placeholder="your-project.firebaseapp.com"
                                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Database URL <span class="text-red-500">*</span></label>
                                    <input type="text" id="fbDatabaseURL" required placeholder="https://your-project-default-rtdb.firebaseio.com"
                                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Project ID <span class="text-red-500">*</span></label>
                                    <input type="text" id="fbProjectId" required placeholder="your-project-id"
                                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Storage Bucket</label>
                                    <input type="text" id="fbStorageBucket" placeholder="your-project.appspot.com"
                                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm">
                                </div>
                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">App ID <span class="text-red-500">*</span></label>
                                    <input type="text" id="fbAppId" required placeholder="1:123456789:web:abc123"
                                        class="w-full px-4 py-2 border rounded-lg font-mono text-sm">
                                </div>
                                
                                <div class="flex gap-2">
                                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                        <i class="fas fa-plug"></i> Hubungkan
                                    </button>
                                    <button type="button" onclick="disconnectFirebase()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
                                        <i class="fas fa-unlink"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Sync & Backup -->
                        <div class="space-y-6">
                            <!-- Sync Status -->
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-sync text-green-600"></i> Sinkronisasi Data
                                </h3>
                                
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="p-4 bg-blue-50 rounded-lg text-center">
                                        <p class="text-sm text-gray-600">Data Lokal</p>
                                        <p class="text-2xl font-bold text-blue-700" id="localDataCount">0</p>
                                        <p class="text-xs text-gray-500">Wajib Pajak</p>
                                    </div>
                                    <div class="p-4 bg-green-50 rounded-lg text-center">
                                        <p class="text-sm text-gray-600">Data Cloud</p>
                                        <p class="text-2xl font-bold text-green-700" id="cloudDataCount">-</p>
                                        <p class="text-xs text-gray-500">Wajib Pajak</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <button onclick="uploadToCloud()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2" id="btnUpload">
                                        <i class="fas fa-cloud-upload-alt"></i> Upload ke Cloud
                                    </button>
                                    <button onclick="downloadFromCloud()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center gap-2" id="btnDownload">
                                        <i class="fas fa-cloud-download-alt"></i> Download dari Cloud
                                    </button>
                                    <button onclick="syncData()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2" id="btnSync">
                                        <i class="fas fa-sync-alt"></i> Sinkronkan (2 Arah)
                                    </button>
                                </div>
                                
                                <div id="syncLog" class="mt-4 max-h-32 overflow-y-auto text-xs font-mono bg-gray-900 text-green-400 p-3 rounded-lg hidden">
                                    <!-- Sync logs -->
                                </div>
                            </div>
                            
                            <!-- Auto Sync Settings -->
                            <div class="bg-white rounded-xl shadow-sm p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-cog text-gray-600"></i> Pengaturan Auto-Sync
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Auto-Sync Saat Simpan</p>
                                            <p class="text-xs text-gray-500">Otomatis upload saat menyimpan data baru</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="autoSyncSave" class="sr-only peer" onchange="saveAutoSyncSettings()">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Real-time Sync</p>
                                            <p class="text-xs text-gray-500">Sinkronisasi real-time dengan database</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="realtimeSync" class="sr-only peer" onchange="toggleRealtimeSync()">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                                <h3 class="text-lg font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                    <i class="fas fa-info-circle"></i> Cara Mendapatkan Konfigurasi Firebase
                                </h3>
                                <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                                    <li>Buka <a href="https://console.firebase.google.com" target="_blank" class="text-blue-600 underline">Firebase Console</a></li>
                                    <li>Buat project baru atau pilih project yang ada</li>
                                    <li>Klik ikon gear ⚙️ → Project Settings</li>
                                    <li>Scroll ke bawah, klik "Add app" → Web</li>
                                    <li>Copy konfigurasi yang muncul</li>
                                    <li>Buka "Realtime Database" → Create Database</li>
                                    <li>Pilih "Start in test mode" (untuk testing)</li>
                                    <li>Paste konfigurasi di form sebelah kiri</li>
                                </ol>
                                
                                <div class="mt-4 p-3 bg-yellow-100 rounded-lg border border-yellow-300">
                                    <p class="text-xs text-yellow-800">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        <strong>Penting:</strong> Untuk produksi, atur Firebase Security Rules agar data aman.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Realisasi Section -->
                <section id="section-realisasi" class="p-8 hidden animate-fade-in">
                    <!-- Filter & Summary -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-sm font-semibold text-gray-600 mb-3">Periode Laporan</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-gray-500">Tahun Anggaran</label>
                                    <input type="number" id="realisasiTahun" class="w-full px-3 py-2 border rounded-lg" 
                                        min="2000" max="2100" onchange="loadRealisasi()" placeholder="Masukkan tahun">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Bulan</label>
                                    <select id="realisasiBulan" class="w-full px-3 py-2 border rounded-lg" onchange="loadRealisasi()">
                                        <option value="">Semua Bulan</option>
                                        <option value="1">Januari</option>
                                        <option value="2">Februari</option>
                                        <option value="3">Maret</option>
                                        <option value="4">April</option>
                                        <option value="5">Mei</option>
                                        <option value="6">Juni</option>
                                        <option value="7">Juli</option>
                                        <option value="8">Agustus</option>
                                        <option value="9">September</option>
                                        <option value="10">Oktober</option>
                                        <option value="11">November</option>
                                        <option value="12">Desember</option>
                                    </select>
                                </div>
                                <button onclick="showInputRealisasiModal()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center justify-center gap-2">
                                    <i class="fas fa-plus"></i> Input Realisasi
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl shadow-sm p-6 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-blue-100 text-sm">Total Target</p>
                                <i class="fas fa-bullseye text-blue-200"></i>
                            </div>
                            <h3 class="text-2xl font-bold" id="totalTarget">Rp 0</h3>
                            <p class="text-xs text-blue-200 mt-1">Tahun <span id="tahunTarget">2024</span></p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-xl shadow-sm p-6 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-green-100 text-sm">Total Realisasi</p>
                                <i class="fas fa-chart-line text-green-200"></i>
                            </div>
                            <h3 class="text-2xl font-bold" id="totalRealisasi">Rp 0</h3>
                            <p class="text-xs text-green-200 mt-1">s/d <span id="periodeRealisasi">Desember 2024</span></p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-xl shadow-sm p-6 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-purple-100 text-sm">Persentase Capaian</p>
                                <i class="fas fa-percentage text-purple-200"></i>
                            </div>
                            <h3 class="text-2xl font-bold" id="persenCapaian">0%</h3>
                            <div class="mt-2 bg-purple-400/30 rounded-full h-2">
                                <div id="progressCapaian" class="bg-white rounded-full h-2 transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart & Table -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Chart -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-bar text-blue-600"></i> Grafik Target vs Realisasi
                            </h3>
                            <div id="chartContainer" class="relative" style="height: 350px;">
                                <canvas id="realisasiChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Pie Chart -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-pie text-green-600"></i> Komposisi Realisasi
                            </h3>
                            <div id="pieChartContainer" class="relative" style="height: 350px;">
                                <canvas id="komposisiChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Detail Table -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-table text-blue-600"></i> Detail Realisasi Per Jenis Pajak
                            </h3>
                            <button onclick="exportRealisasi()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-2">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full" id="realisasiTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Pajak</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Target (Rp)</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Realisasi (Rp)</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Selisih (Rp)</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Capaian (%)</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Progress</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="realisasiTableBody">
                                    <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Memuat data...</td></tr>
                                </tbody>
                                <tfoot class="bg-blue-50 font-semibold">
                                    <tr>
                                        <td colspan="3" class="px-4 py-3 text-sm">TOTAL</td>
                                        <td class="px-4 py-3 text-right text-sm" id="footerTarget">Rp 0</td>
                                        <td class="px-4 py-3 text-right text-sm" id="footerRealisasi">Rp 0</td>
                                        <td class="px-4 py-3 text-right text-sm" id="footerSelisih">Rp 0</td>
                                        <td class="px-4 py-3 text-center text-sm" id="footerCapaian">0%</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Monthly Detail -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-blue-600"></i> Realisasi Bulanan
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm" id="monthlyTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jenis Pajak</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Jan</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Feb</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Mar</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Apr</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Mei</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Jun</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Jul</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Ags</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Sep</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Okt</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Nov</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Des</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 bg-blue-100">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyTableBody">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Data Section -->
                <section id="section-data" class="p-8 hidden animate-fade-in">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Data Wajib Pajak Daerah</h3>
                                <p class="text-sm text-gray-500" id="filter-info">Menampilkan semua data</p>
                            </div>
                            <div class="flex gap-2 flex-wrap">
                                <select id="filterJenisPajak" onchange="filterTable()" class="px-4 py-2 border rounded-lg">
                                    <option value="">Semua Jenis Pajak</option>
                                    <option value="reklame">Pajak Reklame</option>
                                    <option value="air_tanah">Pajak Air Tanah</option>
                                    <option value="sarang_walet">Pajak Sarang Walet</option>
                                    <option value="mineral">Pajak Mineral</option>
                                    <option value="pbb">PBB-P2</option>
                                    <option value="bphtb">BPHTB</option>
                                    <option value="pbjt_makanan">PBJT Makanan</option>
                                    <option value="pbjt_listrik">PBJT Listrik</option>
                                    <option value="pbjt_hotel">PBJT Perhotelan</option>
                                    <option value="pbjt_parkir">PBJT Parkir</option>
                                    <option value="pbjt_hiburan">PBJT Hiburan</option>
                                    <option value="opsen_pkb">Opsen PKB</option>
                                    <option value="opsen_bbnkb">Opsen BBNKB</option>
                                </select>
                                <input type="text" id="searchTable" placeholder="Cari..." 
                                    class="px-4 py-2 border rounded-lg" onkeyup="filterTable()">
                                <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                                    <i class="fas fa-file-excel"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full" id="wpTable">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NPWPD</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama WP</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Pajak</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Alamat</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Koordinat</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="wpTableBody">
                                    <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Belum ada data wajib pajak</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Detail Wajib Pajak</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Map Modal for Coordinate Selection -->
    <div id="mapModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full">
            <div class="border-b px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-map-marked-alt text-blue-600"></i>
                    Pilih Lokasi pada Peta
                </h3>
                <button onclick="closeMapModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="searchLocation" placeholder="Cari lokasi atau alamat..." 
                            class="flex-1 px-4 py-2 border rounded-lg" onkeypress="if(event.key==='Enter') searchAddress()">
                        <button onclick="searchAddress()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-search"></i> Cari
                        </button>
                        <button onclick="getCurrentLocation()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-crosshairs"></i> Lokasi Saya
                        </button>
                    </div>
                </div>
                <div id="mapContainer"></div>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
                            <input type="text" id="mapLat" readonly class="w-full px-4 py-2 border rounded-lg bg-white" placeholder="-">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
                            <input type="text" id="mapLng" readonly class="w-full px-4 py-2 border rounded-lg bg-white" placeholder="-">
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button onclick="closeMapModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Batal
                    </button>
                    <button onclick="confirmLocation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-check"></i> Gunakan Koordinat Ini
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Map Modal -->
    <div id="viewMapModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-4xl w-full">
            <div class="border-b px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-map-marker-alt text-red-600"></i>
                    <span id="viewMapTitle">Lokasi Objek Pajak</span>
                </h3>
                <button onclick="closeViewMapModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="viewMapContainer" style="height: 400px; border-radius: 8px;"></div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-600" id="viewMapCoords"></div>
                    <a id="openGoogleMaps" href="#" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <i class="fab fa-google"></i> Buka di Google Maps
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Realisasi Modal -->
    <div id="realisasiModal" class="modal fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-edit text-blue-600"></i>
                    <span id="realisasiModalTitle">Input Target & Realisasi</span>
                </h3>
                <button onclick="closeRealisasiModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="realisasiForm" onsubmit="saveRealisasi(event)">
                    <input type="hidden" id="editRealisasiId">
                    
                    <!-- Tanggal Input -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-calendar-alt text-blue-600"></i> Tanggal Pencatatan
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Input <span class="text-red-500">*</span></label>
                                <input type="date" id="inputTanggal" required class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Setor</label>
                                <input type="date" id="inputTanggalSetor" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Periode -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Anggaran <span class="text-red-500">*</span></label>
                            <input type="number" id="inputTahun" required class="w-full px-4 py-2 border rounded-lg"
                                min="2000" max="2100" placeholder="Masukkan tahun anggaran">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bulan <span class="text-red-500">*</span></label>
                            <select id="inputBulan" required class="w-full px-4 py-2 border rounded-lg">
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pajak <span class="text-red-500">*</span></label>
                        <select id="inputJenisPajak" required class="w-full px-4 py-2 border rounded-lg">
                            <option value="">Pilih Jenis Pajak</option>
                            <option value="reklame">Pajak Reklame</option>
                            <option value="air_tanah">Pajak Air Tanah</option>
                            <option value="sarang_walet">Pajak Sarang Burung Walet</option>
                            <option value="mineral">Pajak Mineral Bukan Logam dan Batuan</option>
                            <option value="pbb">PBB-P2</option>
                            <option value="bphtb">BPHTB</option>
                            <option value="pbjt_makanan">PBJT - Makanan dan Minuman</option>
                            <option value="pbjt_listrik">PBJT - Tenaga Listrik</option>
                            <option value="pbjt_hotel">PBJT - Jasa Perhotelan</option>
                            <option value="pbjt_parkir">PBJT - Jasa Parkir</option>
                            <option value="pbjt_hiburan">PBJT - Jasa Hiburan</option>
                            <option value="opsen_pkb">Opsen PKB</option>
                            <option value="opsen_bbnkb">Opsen BBNKB</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Target (Rp) <span class="text-red-500">*</span></label>
                            <input type="text" id="inputTarget" required placeholder="0"
                                class="w-full px-4 py-2 border rounded-lg" oninput="formatRupiahInput(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Realisasi (Rp) <span class="text-red-500">*</span></label>
                            <input type="text" id="inputRealisasiNominal" required placeholder="0"
                                class="w-full px-4 py-2 border rounded-lg" oninput="formatRupiahInput(this); hitungCapaianInput()">
                        </div>
                    </div>
                    
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Persentase Capaian:</span>
                            <span class="text-xl font-bold text-blue-700" id="inputCapaian">0%</span>
                        </div>
                        <div class="mt-2 bg-blue-200 rounded-full h-3">
                            <div id="inputProgressBar" class="bg-blue-600 rounded-full h-3 transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                        <textarea id="inputKeterangan" rows="2" placeholder="Keterangan tambahan (opsional)"
                            class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                        <button type="button" onclick="closeRealisasiModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50 flex items-center gap-2">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Data berhasil disimpan</span>
    </div>

    <script>
        // ============= FIREBASE VARIABLES =============
        let firebaseApp = null;
        let firebaseDB = null;
        let firebaseConnected = false;
        let realtimeListener = null;
        
        // ============= GLOBAL VARIABLES =============
        const defaultUsers = [
            { id: 1, username: 'admin', password: 'admin123', name: 'Administrator', role: 'Admin', email: 'admin@sidrap.go.id', status: 'active', createdAt: '2024-01-01' },
            { id: 2, username: 'operator', password: 'operator123', name: 'Operator Pajak', role: 'Operator', email: 'operator@sidrap.go.id', status: 'active', createdAt: '2024-01-01' }
        ];

        let users = JSON.parse(localStorage.getItem('simpatdaUsers')) || defaultUsers;
        let currentUser = null;
        let wajibPajakData = JSON.parse(localStorage.getItem('wajibPajakData')) || [];

        // Map variables
        let map = null;
        let marker = null;
        let viewMap = null;
        let viewMarker = null;
        let blockMap = null;
        let wpMarkersLayer = null;
        let showWPMarkers = false;

        // Layer management for Peta Blok
        let mapLayers = JSON.parse(localStorage.getItem('mapLayers')) || [];
        let layerObjects = {};
        let layerIdCounter = 0;

        const SIDRAP_CENTER = [-3.9667, 119.9833];
        
        // Layer colors
        const layerColors = ['#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

        const taxTypes = {
            reklame: { name: 'Pajak Reklame', icon: 'fa-ad', color: 'blue', tarif: '25%' },
            air_tanah: { name: 'Pajak Air Tanah', icon: 'fa-tint', color: 'cyan', tarif: '20%' },
            sarang_walet: { name: 'Pajak Sarang Burung Walet', icon: 'fa-dove', color: 'amber', tarif: '10%' },
            mineral: { name: 'Pajak Mineral Bukan Logam dan Batuan', icon: 'fa-gem', color: 'emerald', tarif: '20%' },
            pbb: { name: 'PBB-P2', icon: 'fa-home', color: 'indigo', tarif: '0.5%' },
            bphtb: { name: 'BPHTB', icon: 'fa-file-contract', color: 'purple', tarif: '5%' },
            pbjt_makanan: { name: 'PBJT Makanan & Minuman', icon: 'fa-utensils', color: 'red', tarif: '10%' },
            pbjt_listrik: { name: 'PBJT Tenaga Listrik', icon: 'fa-bolt', color: 'yellow', tarif: '3%' },
            pbjt_hotel: { name: 'PBJT Perhotelan', icon: 'fa-hotel', color: 'teal', tarif: '10%' },
            pbjt_parkir: { name: 'PBJT Parkir', icon: 'fa-parking', color: 'orange', tarif: '10%' },
            pbjt_hiburan: { name: 'PBJT Kesenian & Hiburan', icon: 'fa-theater-masks', color: 'pink', tarif: '10%' },
            opsen_pkb: { name: 'Opsen PKB', icon: 'fa-car', color: 'slate', tarif: '66%' },
            opsen_bbnkb: { name: 'Opsen BBNKB', icon: 'fa-exchange-alt', color: 'gray', tarif: '66%' }
        };

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadFirebaseConfig();
            loadAutoSyncSettings();
            updateLocalDataCount();
        });

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            generateNPWPD();
            updateDashboard();
            renderTable();
        }

        // ============= LOGIN FUNCTIONS =============
        function togglePassword() {
            const pwd = document.getElementById('password');
            const icon = document.getElementById('toggleIcon');
            pwd.type = pwd.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.toLowerCase();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            const user = users.find(u => u.username === username && u.password === password);

            if (user && user.status === 'active') {
                currentUser = user;
                (rememberMe ? localStorage : sessionStorage).setItem('currentUser', JSON.stringify(user));
                showMainApp();
            } else {
                document.getElementById('errorMessage').textContent = user ? 'Akun tidak aktif' : 'Username atau password salah';
                document.getElementById('loginError').classList.remove('hidden');
                setTimeout(() => document.getElementById('loginError').classList.add('hidden'), 3000);
            }
        }

        function handleLogout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                localStorage.removeItem('currentUser');
                sessionStorage.removeItem('currentUser');
                location.reload();
            }
        }

        // ============= NAVIGATION =============
        function showSection(section) {
            document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${section}`)?.classList.add('active');
            
            const titles = { dashboard: 'Dashboard', input: 'Input Wajib Pajak', data: 'Data Wajib Pajak', users: 'Manajemen User', petablok: 'Peta Blok', firebase: 'Pengaturan Cloud Storage', realisasi: 'Realisasi Pajak Daerah' };
            document.getElementById('page-title').textContent = titles[section] || 'Dashboard';
            
            if (section === 'input') generateNPWPD();
            if (section === 'data') renderTable();
            if (section === 'dashboard') updateDashboard();
            if (section === 'users') renderUserTable();
            if (section === 'petablok') initBlockMap();
            if (section === 'firebase') updateCloudStatus();
            if (section === 'realisasi') loadRealisasi();
        }

        // ============= PETA BLOK FUNCTIONS =============
        function initBlockMap() {
            if (blockMap) {
                blockMap.invalidateSize();
                return;
            }

            setTimeout(() => {
                blockMap = L.map('blockMapContainer').setView(SIDRAP_CENTER, 11);
                
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                });
                
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '© Esri'
                });
                
                const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenTopoMap'
                });

                osmLayer.addTo(blockMap);
                
                window.baseMaps = { osm: osmLayer, satellite: satelliteLayer, terrain: terrainLayer };
                window.currentBaseMap = osmLayer;

                wpMarkersLayer = L.layerGroup().addTo(blockMap);
                
                // Load saved layers
                loadSavedLayers();
                updateLayerCount();
            }, 100);
        }

        function changeBaseMap() {
            const selected = document.getElementById('baseMapSelector').value;
            if (window.currentBaseMap) {
                blockMap.removeLayer(window.currentBaseMap);
            }
            window.currentBaseMap = window.baseMaps[selected];
            window.currentBaseMap.addTo(blockMap);
        }

        function toggleWPMarkers() {
            showWPMarkers = !showWPMarkers;
            const btn = document.getElementById('btnToggleWP');
            
            if (showWPMarkers) {
                btn.classList.remove('bg-blue-100', 'text-blue-700');
                btn.classList.add('bg-blue-600', 'text-white');
                addWPMarkersToMap();
            } else {
                btn.classList.add('bg-blue-100', 'text-blue-700');
                btn.classList.remove('bg-blue-600', 'text-white');
                wpMarkersLayer.clearLayers();
            }
        }

        function addWPMarkersToMap() {
            wpMarkersLayer.clearLayers();
            wajibPajakData.forEach(wp => {
                if (wp.taxDetails?.latitude && wp.taxDetails?.longitude) {
                    const marker = L.marker([wp.taxDetails.latitude, wp.taxDetails.longitude])
                        .bindPopup(`<strong>${wp.namaWP}</strong><br>${taxTypes[wp.jenisPajak]?.name || wp.jenisPajak}<br>${wp.alamat}`);
                    wpMarkersLayer.addLayer(marker);
                }
            });
        }

        // ============= FILE IMPORT FUNCTIONS =============
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        }

        function handleFileSelect(e) {
            processFiles(e.target.files);
        }

        function processFiles(files) {
            Array.from(files).forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'zip' || ext === 'shp') {
                    importSHPFile(file);
                } else if (ext === 'kmz' || ext === 'kml') {
                    importKMZFile(file);
                } else {
                    showImportStatus('error', `Format file "${ext}" tidak didukung`);
                }
            });
        }

        function importSHP(e) {
            const file = e.target.files[0];
            if (file) importSHPFile(file);
            e.target.value = '';
        }

        function importKMZ(e) {
            const file = e.target.files[0];
            if (file) importKMZFile(file);
            e.target.value = '';
        }

        async function importSHPFile(file) {
            showImportStatus('loading', 'Memproses file SHP...');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const geojson = await shp(arrayBuffer);
                
                const layerName = file.name.replace(/\.(zip|shp)$/i, '');
                addGeoJSONLayer(geojson, layerName);
                
                showImportStatus('success', `Layer "${layerName}" berhasil diimport!`);
            } catch (error) {
                console.error('SHP Import Error:', error);
                showImportStatus('error', 'Gagal memproses file SHP. Pastikan file ZIP berisi .shp, .shx, dan .dbf');
            }
        }

        async function importKMZFile(file) {
            showImportStatus('loading', 'Memproses file KMZ/KML...');
            
            try {
                const ext = file.name.split('.').pop().toLowerCase();
                let kmlText;
                
                if (ext === 'kmz') {
                    const arrayBuffer = await file.arrayBuffer();
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    
                    // Find KML file inside KMZ
                    const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
                    if (!kmlFile) throw new Error('No KML file found in KMZ');
                    
                    kmlText = await zip.files[kmlFile].async('string');
                } else {
                    kmlText = await file.text();
                }
                
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                const geojson = toGeoJSON.kml(kmlDoc);
                
                const layerName = file.name.replace(/\.(kmz|kml)$/i, '');
                addGeoJSONLayer(geojson, layerName);
                
                showImportStatus('success', `Layer "${layerName}" berhasil diimport!`);
            } catch (error) {
                console.error('KMZ/KML Import Error:', error);
                showImportStatus('error', 'Gagal memproses file KMZ/KML');
            }
        }

        function addGeoJSONLayer(geojson, name) {
            const color = layerColors[mapLayers.length % layerColors.length];
            const layerId = ++layerIdCounter;
            
            const layer = L.geoJSON(geojson, {
                style: {
                    color: color,
                    weight: 2,
                    opacity: 0.8,
                    fillColor: color,
                    fillOpacity: 0.3
                },
                pointToLayer: (feature, latlng) => {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: (feature, layer) => {
                    layer.on('click', () => showFeatureInfo(feature.properties, name));
                    
                    if (feature.properties) {
                        const props = Object.entries(feature.properties)
                            .filter(([k, v]) => v !== null && v !== undefined)
                            .map(([k, v]) => `<strong>${k}:</strong> ${v}`)
                            .join('<br>');
                        if (props) layer.bindPopup(props);
                    }
                }
            }).addTo(blockMap);

            layerObjects[layerId] = layer;
            
            const featureCount = geojson.features ? geojson.features.length : 1;
            
            const layerInfo = {
                id: layerId,
                name: name,
                color: color,
                visible: true,
                featureCount: featureCount,
                createdAt: new Date().toISOString()
            };
            
            mapLayers.push(layerInfo);
            saveLayersToStorage();
            renderLayerList();
            updateLegend();
            updateLayerCount();
            
            // Fit to layer bounds
            try {
                blockMap.fitBounds(layer.getBounds());
            } catch (e) {}
        }

        function showFeatureInfo(properties, layerName) {
            const panel = document.getElementById('featureInfoPanel');
            const content = document.getElementById('featureInfoContent');
            
            let html = `<p class="text-xs text-gray-500 mb-2">Layer: ${layerName}</p>`;
            html += '<table class="w-full">';
            
            Object.entries(properties || {}).forEach(([key, value]) => {
                if (value !== null && value !== undefined) {
                    html += `<tr><td class="py-1 text-gray-500 pr-4">${key}</td><td class="py-1">${value}</td></tr>`;
                }
            });
            
            html += '</table>';
            content.innerHTML = html;
            panel.classList.remove('hidden');
        }

        function closeFeatureInfo() {
            document.getElementById('featureInfoPanel').classList.add('hidden');
        }

        function renderLayerList() {
            const container = document.getElementById('layerList');
            
            if (mapLayers.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Belum ada layer</p>';
                return;
            }
            
            container.innerHTML = mapLayers.map(layer => `
                <div class="layer-item p-3 rounded-lg border flex items-center justify-between" id="layer-${layer.id}">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" ${layer.visible ? 'checked' : ''} onchange="toggleLayerVisibility(${layer.id})" class="rounded">
                        <div class="layer-color-box" style="background-color: ${layer.color}"></div>
                        <div>
                            <p class="font-medium text-sm text-gray-800">${layer.name}</p>
                            <p class="text-xs text-gray-500">${layer.featureCount} fitur</p>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="zoomToLayer(${layer.id})" class="p-1 text-blue-600 hover:bg-blue-50 rounded" title="Zoom">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button onclick="removeLayer(${layer.id})" class="p-1 text-red-600 hover:bg-red-50 rounded" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function toggleLayerVisibility(id) {
            const layer = mapLayers.find(l => l.id === id);
            if (layer && layerObjects[id]) {
                layer.visible = !layer.visible;
                if (layer.visible) {
                    layerObjects[id].addTo(blockMap);
                } else {
                    blockMap.removeLayer(layerObjects[id]);
                }
                saveLayersToStorage();
            }
        }

        function zoomToLayer(id) {
            if (layerObjects[id]) {
                try {
                    blockMap.fitBounds(layerObjects[id].getBounds());
                } catch (e) {
                    showToast('Tidak dapat zoom ke layer ini');
                }
            }
        }

        function removeLayer(id) {
            if (confirm('Hapus layer ini?')) {
                if (layerObjects[id]) {
                    blockMap.removeLayer(layerObjects[id]);
                    delete layerObjects[id];
                }
                mapLayers = mapLayers.filter(l => l.id !== id);
                saveLayersToStorage();
                renderLayerList();
                updateLegend();
                updateLayerCount();
                showToast('Layer berhasil dihapus');
            }
        }

        function clearAllLayers() {
            if (mapLayers.length === 0) return;
            if (confirm('Hapus semua layer?')) {
                Object.values(layerObjects).forEach(layer => blockMap.removeLayer(layer));
                layerObjects = {};
                mapLayers = [];
                saveLayersToStorage();
                renderLayerList();
                updateLegend();
                updateLayerCount();
                showToast('Semua layer berhasil dihapus');
            }
        }

        function fitToAllLayers() {
            if (Object.keys(layerObjects).length === 0) return;
            
            const group = L.featureGroup(Object.values(layerObjects));
            try {
                blockMap.fitBounds(group.getBounds());
            } catch (e) {}
        }

        function updateLegend() {
            const container = document.getElementById('legendContainer');
            
            if (mapLayers.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Tidak ada legenda</p>';
                return;
            }
            
            container.innerHTML = mapLayers.map(layer => `
                <div class="legend-item">
                    <div class="layer-color-box" style="background-color: ${layer.color}; width: 16px; height: 16px;"></div>
                    <span class="text-gray-700">${layer.name}</span>
                </div>
            `).join('');
        }

        function updateLayerCount() {
            document.getElementById('layerCount').textContent = `${mapLayers.length} layer`;
            document.getElementById('stat-layers').textContent = mapLayers.length;
        }

        function saveLayersToStorage() {
            // We save layer metadata but not the actual GeoJSON data
            localStorage.setItem('mapLayers', JSON.stringify(mapLayers.map(l => ({
                id: l.id,
                name: l.name,
                color: l.color,
                visible: l.visible,
                featureCount: l.featureCount
            }))));
        }

        function loadSavedLayers() {
            // Note: Actual layer data is not persisted, only metadata
            // User needs to re-import files after page refresh
            mapLayers = [];
            layerObjects = {};
            renderLayerList();
            updateLegend();
        }

        function showImportStatus(type, message) {
            const status = document.getElementById('importStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100', 'text-green-700', 'text-red-700', 'text-blue-700');
            
            if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-700');
                status.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            } else if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-700');
                status.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
            } else {
                status.classList.add('bg-blue-100', 'text-blue-700');
                status.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${message}`;
            }
            
            if (type !== 'loading') {
                setTimeout(() => status.classList.add('hidden'), 5000);
            }
        }

        // ============= CORE FUNCTIONS =============
        function generateNPWPD() {
            const date = new Date();
            const count = String(wajibPajakData.length + 1).padStart(5, '0');
            document.getElementById('npwpd').value = `SIDRAP${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${count}`;
        }

        function toggleJenisWP() {
            document.getElementById('field-nama-usaha').classList.toggle('hidden', document.getElementById('jenisWP').value !== 'badan');
        }

        function showTaxFields() {
            const taxType = document.getElementById('jenisPajak').value;
            const container = document.getElementById('taxFieldsContainer');
            
            if (!taxType) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            // Get form definition from tax-forms.js or use PBB inline
            let specificFields = '';
            
            if (typeof taxFormDefinitions !== 'undefined' && taxFormDefinitions[taxType]) {
                specificFields = taxFormDefinitions[taxType];
            } else if (taxType === 'pbb') {
                // PBB-P2 specific fields (fallback)
                specificFields = `
                    <!-- Data Objek Pajak PBB-P2 -->
                    <div class="mb-6 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <h5 class="text-sm font-semibold text-indigo-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-file-alt"></i> Data Objek Pajak PBB-P2
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="lg:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">NOP (Nomor Objek Pajak) <span class="text-red-500">*</span></label>
                                <input type="text" id="tax_nop" required maxlength="18" placeholder="Contoh: 73.14.010.001.001-0001.0"
                                    class="w-full px-4 py-2 border rounded-lg font-mono" oninput="formatNOP(this)">
                                <p class="text-xs text-gray-500 mt-1">Format: 18 digit (Kode Wilayah.Blok.Urut.Jenis)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Peruntukan <span class="text-red-500">*</span></label>
                                <select id="tax_peruntukan" required class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Pilih Peruntukan</option>
                                    <option value="perumahan">Perumahan/Tempat Tinggal</option>
                                    <option value="perkantoran">Perkantoran</option>
                                    <option value="perdagangan">Perdagangan/Jasa</option>
                                    <option value="industri">Industri</option>
                                    <option value="pertanian">Pertanian</option>
                                    <option value="perkebunan">Perkebunan</option>
                                    <option value="peternakan">Peternakan</option>
                                    <option value="perhutanan">Perhutanan</option>
                                    <option value="pertambangan">Pertambangan</option>
                                    <option value="sosial">Sosial/Keagamaan</option>
                                    <option value="lainnya">Lainnya</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Tanah -->
                    <div class="mb-6 p-4 bg-green-50 rounded-lg border border-green-200">
                        <h5 class="text-sm font-semibold text-green-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-mountain"></i> Data Tanah
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Panjang Tanah (m)</label>
                                <input type="number" id="tax_panjang_tanah" step="0.01" min="0" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg" oninput="hitungLuasTanah()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Lebar Tanah (m)</label>
                                <input type="number" id="tax_lebar_tanah" step="0.01" min="0" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg" oninput="hitungLuasTanah()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Luas Tanah (m²) <span class="text-red-500">*</span></label>
                                <input type="number" id="tax_luas_tanah" required step="0.01" min="0" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg bg-green-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">NJOP Tanah (Rp/m²) <span class="text-red-500">*</span></label>
                                <input type="text" id="tax_njop_tanah" required placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg" oninput="formatRupiah(this); hitungNilaiTanah()">
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-white rounded-lg border">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Nilai Tanah:</span>
                                <span class="text-lg font-bold text-green-700" id="total_nilai_tanah">Rp 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Bangunan -->
                    <div class="mb-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <h5 class="text-sm font-semibold text-amber-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-building"></i> Data Bangunan
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Panjang Bangunan (m)</label>
                                <input type="number" id="tax_panjang_bangunan" step="0.01" min="0" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg" oninput="hitungLuasBangunan()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Lebar Bangunan (m)</label>
                                <input type="number" id="tax_lebar_bangunan" step="0.01" min="0" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg" oninput="hitungLuasBangunan()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Luas Bangunan (m²)</label>
                                <input type="number" id="tax_luas_bangunan" step="0.01" min="0" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg bg-amber-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">NJOP Bangunan (Rp/m²)</label>
                                <input type="text" id="tax_njop_bangunan" placeholder="0"
                                    class="w-full px-4 py-2 border rounded-lg" oninput="formatRupiah(this); hitungNilaiBangunan()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Lantai</label>
                                <input type="number" id="tax_jumlah_lantai" min="0" placeholder="1"
                                    class="w-full px-4 py-2 border rounded-lg" value="1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Dibangun</label>
                                <input type="number" id="tax_tahun_dibangun" min="1900" max="2030" placeholder="2020"
                                    class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kondisi Bangunan</label>
                                <select id="tax_kondisi_bangunan" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Pilih Kondisi</option>
                                    <option value="baik">Baik</option>
                                    <option value="sedang">Sedang</option>
                                    <option value="rusak_ringan">Rusak Ringan</option>
                                    <option value="rusak_berat">Rusak Berat</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Konstruksi</label>
                                <select id="tax_jenis_konstruksi" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="">Pilih Jenis</option>
                                    <option value="permanen">Permanen</option>
                                    <option value="semi_permanen">Semi Permanen</option>
                                    <option value="non_permanen">Non Permanen</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-white rounded-lg border">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Nilai Bangunan:</span>
                                <span class="text-lg font-bold text-amber-700" id="total_nilai_bangunan">Rp 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ringkasan NJOP -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h5 class="text-sm font-semibold text-blue-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-calculator"></i> Ringkasan NJOP
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-white rounded-lg border text-center">
                                <p class="text-sm text-gray-500">Nilai Tanah</p>
                                <p class="text-xl font-bold text-green-600" id="ringkasan_tanah">Rp 0</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg border text-center">
                                <p class="text-sm text-gray-500">Nilai Bangunan</p>
                                <p class="text-xl font-bold text-amber-600" id="ringkasan_bangunan">Rp 0</p>
                            </div>
                            <div class="p-4 bg-blue-100 rounded-lg border-2 border-blue-300 text-center">
                                <p class="text-sm text-blue-700">Total NJOP</p>
                                <p class="text-2xl font-bold text-blue-800" id="total_njop">Rp 0</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Get koordinat section
            const koordinatHtml = typeof koordinatSection !== 'undefined' ? koordinatSection : `
                <div class="p-4 bg-gray-50 rounded-lg border">
                    <h5 class="text-sm font-semibold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-red-500"></i> Koordinat Lokasi Objek Pajak
                    </h5>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Latitude</label>
                            <input type="text" id="tax_latitude" class="w-full px-4 py-2 border rounded-lg bg-white" readonly placeholder="-">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Longitude</label>
                            <input type="text" id="tax_longitude" class="w-full px-4 py-2 border rounded-lg bg-white" readonly placeholder="-">
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="openMapModal()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-map-marker-alt mr-2"></i> Pilih Lokasi dari Peta
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = `
                <h4 class="text-md font-semibold text-gray-700 mb-4">
                    <i class="fas ${taxTypes[taxType]?.icon || 'fa-info-circle'} text-blue-600 mr-2"></i>
                    Data Khusus ${taxTypes[taxType]?.name || 'Pajak'}
                </h4>
                ${specificFields}
                ${koordinatHtml}
            `;
        }
        
        // Format NOP PBB
        function formatNOP(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 18) value = value.slice(0, 18);
            
            // Format: XX.XX.XXX.XXX.XXX-XXXX.X
            let formatted = '';
            for (let i = 0; i < value.length; i++) {
                if (i === 2 || i === 4 || i === 7 || i === 10 || i === 13) formatted += '.';
                if (i === 13) formatted = formatted.slice(0, -1) + '-';
                if (i === 17) formatted += '.';
                formatted += value[i];
            }
            input.value = formatted;
        }
        
        // Format Rupiah
        function formatRupiah(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = new Intl.NumberFormat('id-ID').format(value);
            }
        }
        
        // Parse Rupiah to Number
        function parseRupiah(str) {
            if (!str) return 0;
            return parseInt(str.replace(/[^0-9]/g, '')) || 0;
        }
        
        // Hitung Luas Tanah
        function hitungLuasTanah() {
            const panjang = parseFloat(document.getElementById('tax_panjang_tanah')?.value) || 0;
            const lebar = parseFloat(document.getElementById('tax_lebar_tanah')?.value) || 0;
            const luas = panjang * lebar;
            const luasField = document.getElementById('tax_luas_tanah');
            if (luasField && panjang > 0 && lebar > 0) {
                luasField.value = luas.toFixed(2);
            }
            hitungNilaiTanah();
        }
        
        // Hitung Luas Bangunan
        function hitungLuasBangunan() {
            const panjang = parseFloat(document.getElementById('tax_panjang_bangunan')?.value) || 0;
            const lebar = parseFloat(document.getElementById('tax_lebar_bangunan')?.value) || 0;
            const luas = panjang * lebar;
            const luasField = document.getElementById('tax_luas_bangunan');
            if (luasField && panjang > 0 && lebar > 0) {
                luasField.value = luas.toFixed(2);
            }
            hitungNilaiBangunan();
        }
        
        // Hitung Nilai Tanah
        function hitungNilaiTanah() {
            const luas = parseFloat(document.getElementById('tax_luas_tanah')?.value) || 0;
            const njop = parseRupiah(document.getElementById('tax_njop_tanah')?.value);
            const total = luas * njop;
            
            const totalEl = document.getElementById('total_nilai_tanah');
            const ringkasanEl = document.getElementById('ringkasan_tanah');
            if (totalEl) totalEl.textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(total);
            if (ringkasanEl) ringkasanEl.textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(total);
            
            hitungTotalNJOP();
        }
        
        // Hitung Nilai Bangunan
        function hitungNilaiBangunan() {
            const luas = parseFloat(document.getElementById('tax_luas_bangunan')?.value) || 0;
            const njop = parseRupiah(document.getElementById('tax_njop_bangunan')?.value);
            const total = luas * njop;
            
            const totalEl = document.getElementById('total_nilai_bangunan');
            const ringkasanEl = document.getElementById('ringkasan_bangunan');
            if (totalEl) totalEl.textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(total);
            if (ringkasanEl) ringkasanEl.textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(total);
            
            hitungTotalNJOP();
        }
        
        // Hitung Total NJOP
        function hitungTotalNJOP() {
            const luasTanah = parseFloat(document.getElementById('tax_luas_tanah')?.value) || 0;
            const njopTanah = parseRupiah(document.getElementById('tax_njop_tanah')?.value);
            const luasBangunan = parseFloat(document.getElementById('tax_luas_bangunan')?.value) || 0;
            const njopBangunan = parseRupiah(document.getElementById('tax_njop_bangunan')?.value);
            
            const nilaiTanah = luasTanah * njopTanah;
            const nilaiBangunan = luasBangunan * njopBangunan;
            const totalNJOP = nilaiTanah + nilaiBangunan;
            
            const totalEl = document.getElementById('total_njop');
            if (totalEl) totalEl.textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(totalNJOP);
        }

        // ============= BPHTB FUNCTIONS =============
        // Fungsi untuk mengecek riwayat perolehan berdasarkan NIK
        function cekRiwayatPerolehanNIK() {
            const nikPenerima = document.getElementById('tax_nik_penerima')?.value;
            const hasilContainer = document.getElementById('hasil_cek_nik');
            const statusContainer = document.getElementById('status_perolehan_container');
            const perolehanKeField = document.getElementById('tax_perolehan_ke');
            
            if (!nikPenerima || nikPenerima.length < 16) {
                alert('Masukkan NIK 16 digit dengan benar!');
                return;
            }
            
            // Cek apakah NIK sudah pernah melakukan transaksi BPHTB sebelumnya
            const riwayatBPHTB = wajibPajakData.filter(wp => 
                wp.jenisPajak === 'bphtb' && 
                (wp.taxDetails?.nik_penerima === nikPenerima || wp.nikNpwp === nikPenerima)
            );
            
            hasilContainer.classList.remove('hidden');
            
            if (riwayatBPHTB.length === 0) {
                // Belum pernah ada perolehan - PEROLEHAN PERTAMA
                hasilContainer.className = 'mt-4 p-3 rounded-lg bg-green-100 border border-green-300';
                hasilContainer.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white flex-shrink-0">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-green-800">✓ Perolehan Pertama</p>
                            <p class="text-sm text-green-700 mt-1">NIK <span class="font-mono font-bold">${nikPenerima}</span> belum pernah tercatat melakukan perolehan hak atas tanah dan/atau bangunan.</p>
                            <p class="text-sm text-green-600 mt-2"><i class="fas fa-info-circle mr-1"></i> Berhak mendapat NPOPTKP Rp 80.000.000 (untuk perolehan selain waris)</p>
                        </div>
                    </div>
                `;
                
                statusContainer.className = 'px-4 py-2 border rounded-lg bg-green-100 text-green-700 text-sm font-semibold';
                statusContainer.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Perolehan Pertama';
                
                // Set otomatis ke perolehan pertama
                if (perolehanKeField) {
                    perolehanKeField.value = '1';
                    perolehanKeField.classList.remove('bg-gray-100', 'bg-red-100');
                    perolehanKeField.classList.add('bg-green-100');
                }
                
            } else {
                // Sudah pernah ada perolehan - PEROLEHAN KEDUA ATAU LEBIH
                const jumlahPerolehan = riwayatBPHTB.length;
                
                const jenisPerolehanLabels = {
                    jual_beli: 'Jual Beli',
                    tukar_menukar: 'Tukar Menukar',
                    hibah: 'Hibah',
                    hibah_wasiat: 'Hibah Wasiat',
                    waris: 'Waris',
                    pemasukan_modal: 'Pemasukan Modal',
                    pemisahan_hak: 'Pemisahan Hak',
                    penggabungan_usaha: 'Penggabungan Usaha',
                    peleburan_usaha: 'Peleburan Usaha',
                    hadiah: 'Hadiah',
                    lelang: 'Lelang',
                    pemberian_hak_baru: 'Pemberian Hak Baru'
                };
                
                hasilContainer.className = 'mt-4 p-3 rounded-lg bg-red-100 border border-red-300';
                hasilContainer.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white flex-shrink-0">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-red-800">✗ Perolehan Ke-${jumlahPerolehan + 1}</p>
                            <p class="text-sm text-red-700 mt-1">NIK <span class="font-mono font-bold">${nikPenerima}</span> sudah tercatat <strong>${jumlahPerolehan} kali</strong> melakukan perolehan hak atas tanah dan/atau bangunan.</p>
                            <p class="text-sm text-red-600 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i> <strong>Tidak berhak</strong> mendapat NPOPTKP Rp 80.000.000 (selain waris)</p>
                            
                            <div class="mt-3 p-2 bg-white rounded border">
                                <p class="text-xs font-semibold text-gray-700 mb-2">Riwayat Perolehan:</p>
                                <div class="max-h-32 overflow-y-auto">
                                    <table class="w-full text-xs">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-2 py-1 text-left">No</th>
                                                <th class="px-2 py-1 text-left">Tanggal</th>
                                                <th class="px-2 py-1 text-left">Jenis</th>
                                                <th class="px-2 py-1 text-left">Lokasi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${riwayatBPHTB.map((r, i) => `
                                                <tr class="border-b">
                                                    <td class="px-2 py-1">${i + 1}</td>
                                                    <td class="px-2 py-1">${new Date(r.createdAt).toLocaleDateString('id-ID')}</td>
                                                    <td class="px-2 py-1">${jenisPerolehanLabels[r.taxDetails?.jenis_perolehan] || r.taxDetails?.jenis_perolehan || '-'}</td>
                                                    <td class="px-2 py-1">${r.kelurahan}, ${r.kecamatan}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                statusContainer.className = 'px-4 py-2 border rounded-lg bg-red-100 text-red-700 text-sm font-semibold';
                statusContainer.innerHTML = `<i class="fas fa-times-circle mr-1"></i> Perolehan Ke-${jumlahPerolehan + 1}`;
                
                // Set otomatis ke perolehan kedua atau lebih
                if (perolehanKeField) {
                    perolehanKeField.value = '2';
                    perolehanKeField.classList.remove('bg-gray-100', 'bg-green-100');
                    perolehanKeField.classList.add('bg-red-100');
                }
            }
            
            // Update NPOPTKP
            updateNPOPTKP();
        }

        // Fungsi untuk update NPOPTKP berdasarkan jenis perolehan dan perolehan ke-
        function updateNPOPTKP() {
            const jenisPerolehan = document.getElementById('tax_jenis_perolehan')?.value;
            const perolehanKe = document.getElementById('tax_perolehan_ke')?.value;
            
            const npoptkpField = document.getElementById('tax_npoptkp');
            const keteranganField = document.getElementById('tax_npoptkp_keterangan');
            
            if (!npoptkpField) return;
            
            let npoptkpValue = 0;
            let keterangan = '';
            
            if (jenisPerolehan === 'waris') {
                // Perolehan karena WARIS = Rp 300.000.000 (berlaku untuk semua perolehan waris)
                npoptkpValue = 300000000;
                keterangan = 'Perolehan karena Waris';
            } else if (jenisPerolehan && perolehanKe === '1') {
                // Perolehan PERTAMA selain waris = Rp 80.000.000
                npoptkpValue = 80000000;
                keterangan = 'Perolehan Pertama (Selain Waris)';
            } else if (jenisPerolehan && perolehanKe === '2') {
                // Perolehan KEDUA atau lebih selain waris = Rp 0 (tidak ada NPOPTKP)
                npoptkpValue = 0;
                keterangan = 'Perolehan Kedua/Lebih (Tidak Ada NPOPTKP)';
            } else {
                // Default untuk perolehan pertama
                npoptkpValue = 80000000;
                keterangan = 'Perolehan Pertama (Selain Waris)';
            }
            
            npoptkpField.value = new Intl.NumberFormat('id-ID').format(npoptkpValue);
            
            // Update warna background berdasarkan nilai NPOPTKP
            npoptkpField.classList.remove('bg-indigo-100', 'bg-green-100', 'bg-red-100', 'bg-gray-100', 'text-indigo-800', 'text-green-800', 'text-red-800');
            
            if (npoptkpValue === 300000000) {
                npoptkpField.classList.add('bg-green-100', 'text-green-800');
            } else if (npoptkpValue === 0) {
                npoptkpField.classList.add('bg-red-100', 'text-red-800');
            } else {
                npoptkpField.classList.add('bg-indigo-100', 'text-indigo-800');
            }
            
            if (keteranganField) keteranganField.value = keterangan;
            
            // Hitung ulang BPHTB
            hitungBPHTB();
        }

        // Fungsi untuk menghitung BPHTB
        function hitungBPHTB() {
            const npop = parseRupiah(document.getElementById('tax_npop')?.value);
            const jenisPerolehan = document.getElementById('tax_jenis_perolehan')?.value;
            const perolehanKe = document.getElementById('tax_perolehan_ke')?.value;
            
            // Hitung NPOPTKP berdasarkan jenis perolehan dan perolehan ke-
            let npoptkp = 0;
            
            if (jenisPerolehan === 'waris') {
                // Perolehan karena WARIS = Rp 300.000.000 (berlaku untuk semua)
                npoptkp = 300000000;
            } else if (jenisPerolehan && perolehanKe === '1') {
                // Perolehan PERTAMA selain waris = Rp 80.000.000
                npoptkp = 80000000;
            } else if (jenisPerolehan && perolehanKe === '2') {
                // Perolehan KEDUA atau lebih selain waris = Rp 0 (tidak ada NPOPTKP)
                npoptkp = 0;
            } else {
                // Default untuk perolehan pertama
                npoptkp = 80000000;
            }
            
            const npopKenaPajak = Math.max(0, npop - npoptkp);
            const bphtb = npopKenaPajak * 0.05; // 5%
            
            const kenaPajakField = document.getElementById('tax_npop_kena_pajak');
            const bphtbField = document.getElementById('tax_bphtb_terutang');
            
            if (kenaPajakField) kenaPajakField.value = 'Rp ' + new Intl.NumberFormat('id-ID').format(npopKenaPajak);
            if (bphtbField) bphtbField.value = 'Rp ' + new Intl.NumberFormat('id-ID').format(bphtb);
        }

        function saveWajibPajak(event) {
            event.preventDefault();
            
            const jenisPajak = document.getElementById('jenisPajak').value;
            
            let taxDetails = {
                latitude: document.getElementById('tax_latitude')?.value || '',
                longitude: document.getElementById('tax_longitude')?.value || ''
            };
            
            // Collect all tax-specific fields dynamically
            const taxContainer = document.getElementById('taxFieldsContainer');
            const inputs = taxContainer.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.id && input.id.startsWith('tax_') && input.id !== 'tax_latitude' && input.id !== 'tax_longitude') {
                    const key = input.id.replace('tax_', '');
                    if (input.type === 'checkbox') {
                        taxDetails[key] = input.checked;
                    } else if (input.value) {
                        // Parse rupiah fields
                        if (input.classList.contains('rupiah') || input.id.includes('njop') || input.id.includes('harga') || input.id.includes('tarif') || input.id.includes('nilai') || input.id.includes('omzet') || input.id.includes('biaya')) {
                            taxDetails[key] = parseRupiah(input.value);
                        } else {
                            taxDetails[key] = input.value;
                        }
                    }
                }
            });
            
            // PBB-P2 specific data (legacy support)
            if (jenisPajak === 'pbb') {
                taxDetails.njopTanah = parseRupiah(document.getElementById('tax_njop_tanah')?.value);
                taxDetails.njopBangunan = parseRupiah(document.getElementById('tax_njop_bangunan')?.value);
            }
            
            const wpData = {
                id: Date.now(),
                npwpd: document.getElementById('npwpd').value,
                jenisWP: document.getElementById('jenisWP').value,
                nikNpwp: document.getElementById('nikNpwp').value,
                namaWP: document.getElementById('namaWP').value,
                namaUsaha: document.getElementById('namaUsaha').value,
                telepon: document.getElementById('telepon').value,
                email: document.getElementById('email').value,
                alamat: document.getElementById('alamat').value,
                kelurahan: document.getElementById('kelurahan').value,
                kecamatan: document.getElementById('kecamatan').value,
                kabupaten: document.getElementById('kabupaten').value,
                kodePos: document.getElementById('kodePos').value,
                jenisPajak: jenisPajak,
                taxDetails: taxDetails,
                createdAt: new Date().toISOString()
            };
            
            wajibPajakData.push(wpData);
            localStorage.setItem('wajibPajakData', JSON.stringify(wajibPajakData));
            
            // Auto sync to cloud if enabled
            autoSyncAfterSave();
            updateLocalDataCount();
            
            showToast('Data wajib pajak berhasil disimpan!');
            resetForm();
            updateDashboard();
        }

        function resetForm() {
            document.getElementById('wpForm').reset();
            document.getElementById('taxFieldsContainer').classList.add('hidden');
            document.getElementById('field-nama-usaha').classList.add('hidden');
            document.getElementById('kabupaten').value = 'Sidenreng Rappang';
            generateNPWPD();
        }

        function updateDashboard() {
            document.getElementById('stat-total').textContent = wajibPajakData.length;
            document.getElementById('stat-badan').textContent = wajibPajakData.filter(wp => wp.jenisWP === 'badan').length;
            document.getElementById('stat-pribadi').textContent = wajibPajakData.filter(wp => wp.jenisWP === 'pribadi').length;
            document.getElementById('stat-layers').textContent = mapLayers.length;
            
            const statsGrid = document.getElementById('tax-stats-grid');
            statsGrid.innerHTML = Object.keys(taxTypes).map(key => {
                const count = wajibPajakData.filter(wp => wp.jenisPajak === key).length;
                return `
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-${taxTypes[key].color}-500 card-hover cursor-pointer" onclick="filterByTax('${key}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-500">${taxTypes[key].name}</p>
                                <h4 class="text-2xl font-bold text-gray-800">${count}</h4>
                            </div>
                            <i class="fas ${taxTypes[key].icon} text-${taxTypes[key].color}-500 text-xl"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            const recentTable = document.getElementById('recent-table');
            const recentData = [...wajibPajakData].reverse().slice(0, 5);
            recentTable.innerHTML = recentData.length === 0 
                ? '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Belum ada data</td></tr>'
                : recentData.map(wp => `
                    <tr class="table-row border-b">
                        <td class="px-4 py-3 text-sm font-medium text-blue-600">${wp.npwpd}</td>
                        <td class="px-4 py-3 text-sm">${wp.namaWP}</td>
                        <td class="px-4 py-3 text-sm"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${taxTypes[wp.jenisPajak]?.name || wp.jenisPajak}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-500">${new Date(wp.createdAt).toLocaleDateString('id-ID')}</td>
                    </tr>
                `).join('');
        }

        function renderTable(data = wajibPajakData) {
            const tbody = document.getElementById('wpTableBody');
            tbody.innerHTML = data.length === 0 
                ? '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Tidak ada data</td></tr>'
                : data.map((wp, i) => `
                    <tr class="table-row border-b">
                        <td class="px-4 py-3 text-sm">${i + 1}</td>
                        <td class="px-4 py-3 text-sm font-medium text-blue-600">${wp.npwpd}</td>
                        <td class="px-4 py-3 text-sm font-medium">${wp.namaWP}</td>
                        <td class="px-4 py-3 text-sm"><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${taxTypes[wp.jenisPajak]?.name || wp.jenisPajak}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-500">${wp.kelurahan}, ${wp.kecamatan}</td>
                        <td class="px-4 py-3 text-sm">
                            ${wp.taxDetails?.latitude ? `<button onclick="viewLocationOnMap(${wp.taxDetails.latitude}, ${wp.taxDetails.longitude}, '${wp.namaWP}')" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs"><i class="fas fa-map-marker-alt"></i> Lihat</button>` : '-'}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="viewDetail(${wp.id})" class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteWP(${wp.id})" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
        }

        function filterTable() {
            const search = document.getElementById('searchTable').value.toLowerCase();
            const taxFilter = document.getElementById('filterJenisPajak').value;
            let filtered = wajibPajakData;
            if (taxFilter) filtered = filtered.filter(wp => wp.jenisPajak === taxFilter);
            if (search) filtered = filtered.filter(wp => wp.namaWP.toLowerCase().includes(search) || wp.npwpd.toLowerCase().includes(search));
            document.getElementById('filter-info').textContent = `Menampilkan ${filtered.length} dari ${wajibPajakData.length} data`;
            renderTable(filtered);
        }

        function filterByTax(taxType) {
            showSection('data');
            document.getElementById('filterJenisPajak').value = taxType === 'all' ? '' : taxType;
            filterTable();
        }

        function globalSearchWP() {
            const search = document.getElementById('globalSearch').value;
            if (search.length >= 3) {
                showSection('data');
                document.getElementById('searchTable').value = search;
                filterTable();
            }
        }

        function viewDetail(id) {
            const wp = wajibPajakData.find(w => w.id === id);
            if (!wp) return;
            
            let pbbDetails = '';
            if (wp.jenisPajak === 'pbb' && wp.taxDetails) {
                const peruntukanLabels = {
                    perumahan: 'Perumahan/Tempat Tinggal',
                    perkantoran: 'Perkantoran',
                    perdagangan: 'Perdagangan/Jasa',
                    industri: 'Industri',
                    pertanian: 'Pertanian',
                    perkebunan: 'Perkebunan',
                    peternakan: 'Peternakan',
                    perhutanan: 'Perhutanan',
                    pertambangan: 'Pertambangan',
                    sosial: 'Sosial/Keagamaan',
                    lainnya: 'Lainnya'
                };
                
                const kondisiLabels = {
                    baik: 'Baik',
                    sedang: 'Sedang',
                    rusak_ringan: 'Rusak Ringan',
                    rusak_berat: 'Rusak Berat'
                };
                
                const konstruksiLabels = {
                    permanen: 'Permanen',
                    semi_permanen: 'Semi Permanen',
                    non_permanen: 'Non Permanen'
                };
                
                const nilaiTanah = (parseFloat(wp.taxDetails.luasTanah) || 0) * (wp.taxDetails.njopTanah || 0);
                const nilaiBangunan = (parseFloat(wp.taxDetails.luasBangunan) || 0) * (wp.taxDetails.njopBangunan || 0);
                const totalNJOP = nilaiTanah + nilaiBangunan;
                
                pbbDetails = `
                    <div class="col-span-2 mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-home text-indigo-600"></i> Data PBB-P2
                        </h4>
                    </div>
                    <div><p class="text-gray-500">NOP</p><p class="font-mono font-medium">${wp.taxDetails.nop || '-'}</p></div>
                    <div><p class="text-gray-500">Peruntukan</p><p>${peruntukanLabels[wp.taxDetails.peruntukan] || '-'}</p></div>
                    
                    <div class="col-span-2 mt-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <h5 class="text-sm font-semibold text-green-700 mb-2"><i class="fas fa-mountain mr-1"></i> Data Tanah</h5>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="text-gray-500">Panjang:</span> ${wp.taxDetails.panjangTanah || '-'} m</div>
                                    <div><span class="text-gray-500">Lebar:</span> ${wp.taxDetails.lebarTanah || '-'} m</div>
                                    <div><span class="text-gray-500">Luas:</span> ${wp.taxDetails.luasTanah || '-'} m²</div>
                                    <div><span class="text-gray-500">NJOP:</span> Rp ${new Intl.NumberFormat('id-ID').format(wp.taxDetails.njopTanah || 0)}/m²</div>
                                </div>
                                <div class="mt-2 pt-2 border-t border-green-200">
                                    <span class="text-gray-600">Nilai Tanah:</span>
                                    <span class="font-bold text-green-700 ml-2">Rp ${new Intl.NumberFormat('id-ID').format(nilaiTanah)}</span>
                                </div>
                            </div>
                            <div class="p-3 bg-amber-50 rounded-lg">
                                <h5 class="text-sm font-semibold text-amber-700 mb-2"><i class="fas fa-building mr-1"></i> Data Bangunan</h5>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div><span class="text-gray-500">Panjang:</span> ${wp.taxDetails.panjangBangunan || '-'} m</div>
                                    <div><span class="text-gray-500">Lebar:</span> ${wp.taxDetails.lebarBangunan || '-'} m</div>
                                    <div><span class="text-gray-500">Luas:</span> ${wp.taxDetails.luasBangunan || '-'} m²</div>
                                    <div><span class="text-gray-500">NJOP:</span> Rp ${new Intl.NumberFormat('id-ID').format(wp.taxDetails.njopBangunan || 0)}/m²</div>
                                    <div><span class="text-gray-500">Lantai:</span> ${wp.taxDetails.jumlahLantai || '-'}</div>
                                    <div><span class="text-gray-500">Tahun:</span> ${wp.taxDetails.tahunDibangun || '-'}</div>
                                    <div><span class="text-gray-500">Kondisi:</span> ${kondisiLabels[wp.taxDetails.kondisiBangunan] || '-'}</div>
                                    <div><span class="text-gray-500">Konstruksi:</span> ${konstruksiLabels[wp.taxDetails.jenisKonstruksi] || '-'}</div>
                                </div>
                                <div class="mt-2 pt-2 border-t border-amber-200">
                                    <span class="text-gray-600">Nilai Bangunan:</span>
                                    <span class="font-bold text-amber-700 ml-2">Rp ${new Intl.NumberFormat('id-ID').format(nilaiBangunan)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-span-2 mt-3">
                        <div class="p-4 bg-blue-100 rounded-lg text-center">
                            <span class="text-blue-700">Total NJOP:</span>
                            <span class="text-2xl font-bold text-blue-800 ml-2">Rp ${new Intl.NumberFormat('id-ID').format(totalNJOP)}</span>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('modalContent').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-gray-500">NPWPD</p><p class="font-medium">${wp.npwpd}</p></div>
                    <div><p class="text-gray-500">Nama</p><p class="font-medium">${wp.namaWP}</p></div>
                    <div><p class="text-gray-500">Jenis Pajak</p><p><span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm">${taxTypes[wp.jenisPajak]?.name || wp.jenisPajak}</span></p></div>
                    <div><p class="text-gray-500">NIK/NPWP</p><p>${wp.nikNpwp}</p></div>
                    <div><p class="text-gray-500">Alamat</p><p>${wp.alamat}, ${wp.kelurahan}, ${wp.kecamatan}</p></div>
                    <div><p class="text-gray-500">Telepon</p><p>${wp.telepon}</p></div>
                    <div><p class="text-gray-500">Email</p><p>${wp.email || '-'}</p></div>
                    <div><p class="text-gray-500">Tanggal Daftar</p><p>${new Date(wp.createdAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p></div>
                    ${wp.taxDetails?.latitude ? `
                        <div class="col-span-2">
                            <p class="text-gray-500">Koordinat</p>
                            <p>${wp.taxDetails.latitude}, ${wp.taxDetails.longitude}
                                <button onclick="viewLocationOnMap(${wp.taxDetails.latitude}, ${wp.taxDetails.longitude}, '${wp.namaWP}')" class="ml-2 px-2 py-1 bg-green-100 text-green-700 rounded text-xs hover:bg-green-200">
                                    <i class="fas fa-map-marker-alt"></i> Lihat Peta
                                </button>
                            </p>
                        </div>
                    ` : ''}
                    ${pbbDetails}
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }

        function deleteWP(id) {
            if (confirm('Hapus data wajib pajak ini?')) {
                wajibPajakData = wajibPajakData.filter(wp => wp.id !== id);
                localStorage.setItem('wajibPajakData', JSON.stringify(wajibPajakData));
                showToast('Data berhasil dihapus');
                renderTable();
                updateDashboard();
            }
        }

        function exportData() {
            const headers = ['NPWPD', 'Nama', 'Jenis Pajak', 'Alamat', 'Telepon', 'Email', 'Latitude', 'Longitude'];
            let csv = headers.join(',') + '\n';
            wajibPajakData.forEach(wp => {
                csv += [wp.npwpd, `"${wp.namaWP}"`, taxTypes[wp.jenisPajak]?.name || wp.jenisPajak, `"${wp.alamat}"`, wp.telepon, wp.email, wp.taxDetails?.latitude || '', wp.taxDetails?.longitude || ''].join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `data_wp_sidrap_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('Data berhasil diekspor!');
        }

        // ============= MAP MODAL FUNCTIONS =============
        function openMapModal() {
            document.getElementById('mapModal').classList.remove('hidden');
            setTimeout(() => {
                if (map) map.remove();
                map = L.map('mapContainer').setView(SIDRAP_CENTER, 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                map.on('click', e => setMarker(e.latlng.lat, e.latlng.lng));
            }, 100);
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.add('hidden');
            if (map) { map.remove(); map = null; marker = null; }
        }

        function setMarker(lat, lng) {
            if (marker) marker.setLatLng([lat, lng]);
            else marker = L.marker([lat, lng], { draggable: true }).addTo(map).on('dragend', e => {
                const pos = e.target.getLatLng();
                document.getElementById('mapLat').value = pos.lat.toFixed(6);
                document.getElementById('mapLng').value = pos.lng.toFixed(6);
            });
            map.setView([lat, lng], 16);
            document.getElementById('mapLat').value = lat.toFixed(6);
            document.getElementById('mapLng').value = lng.toFixed(6);
        }

        function searchAddress() {
            const query = document.getElementById('searchLocation').value;
            if (!query) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) setMarker(parseFloat(data[0].lat), parseFloat(data[0].lon));
                    else alert('Lokasi tidak ditemukan');
                });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => setMarker(pos.coords.latitude, pos.coords.longitude),
                    () => alert('Gagal mendapatkan lokasi')
                );
            }
        }

        function confirmLocation() {
            const lat = document.getElementById('mapLat').value;
            const lng = document.getElementById('mapLng').value;
            if (!lat || !lng) { alert('Pilih lokasi terlebih dahulu'); return; }
            document.getElementById('tax_latitude').value = lat;
            document.getElementById('tax_longitude').value = lng;
            closeMapModal();
            showToast('Koordinat berhasil dipilih!');
        }

        function viewLocationOnMap(lat, lng, title) {
            document.getElementById('viewMapModal').classList.remove('hidden');
            document.getElementById('viewMapTitle').textContent = title;
            document.getElementById('viewMapCoords').textContent = `${lat}, ${lng}`;
            document.getElementById('openGoogleMaps').href = `https://www.google.com/maps?q=${lat},${lng}`;
            setTimeout(() => {
                if (viewMap) viewMap.remove();
                viewMap = L.map('viewMapContainer').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(viewMap);
                L.marker([lat, lng]).addTo(viewMap).bindPopup(title).openPopup();
            }, 100);
        }

        function closeViewMapModal() {
            document.getElementById('viewMapModal').classList.add('hidden');
            if (viewMap) { viewMap.remove(); viewMap = null; }
        }

        // ============= USER MANAGEMENT =============
        function toggleUserPassword() {
            const pwd = document.getElementById('userPassword');
            const icon = document.getElementById('toggleUserPwIcon');
            pwd.type = pwd.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        function saveUser(event) {
            event.preventDefault();
            const editId = document.getElementById('editUserId').value;
            const userData = {
                name: document.getElementById('userFullName').value,
                username: document.getElementById('userUsername').value.toLowerCase(),
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                role: document.getElementById('userRole2').value,
                status: document.getElementById('userStatus').value,
                phone: document.getElementById('userPhone').value
            };

            if (editId) {
                const idx = users.findIndex(u => u.id === parseInt(editId));
                if (idx !== -1) {
                    users[idx] = { ...users[idx], ...userData };
                    if (!userData.password) delete users[idx].password;
                }
            } else {
                if (!userData.password || userData.password.length < 6) { alert('Password minimal 6 karakter'); return; }
                users.push({ id: Date.now(), ...userData, createdAt: new Date().toISOString() });
            }
            
            localStorage.setItem('simpatdaUsers', JSON.stringify(users));
            showToast(editId ? 'User berhasil diperbarui!' : 'User berhasil ditambahkan!');
            resetUserForm();
            renderUserTable();
        }

        function resetUserForm() {
            document.getElementById('userForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('userFormTitle').textContent = 'Tambah User Baru';
            document.getElementById('userFormBtn').textContent = 'Simpan';
        }

        function renderUserTable() {
            const tbody = document.getElementById('userTableBody');
            document.getElementById('userCount').textContent = `Total: ${users.length} user`;
            
            tbody.innerHTML = users.map(user => `
                <tr class="table-row border-b">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">${user.name.charAt(0)}</div>
                            <div><p class="font-medium">${user.name}</p><p class="text-xs text-gray-500">${user.email || '-'}</p></div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm"><span class="font-mono bg-gray-100 px-2 py-1 rounded">${user.username}</span></td>
                    <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded text-xs ${user.role === 'Admin' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">${user.role}</span></td>
                    <td class="px-4 py-3 text-sm"><span class="${user.status === 'active' ? 'text-green-600' : 'text-gray-400'}"><i class="fas ${user.status === 'active' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${user.status === 'active' ? 'Aktif' : 'Tidak Aktif'}</span></td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="editUser(${user.id})" class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteUser(${user.id})" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            document.getElementById('editUserId').value = user.id;
            document.getElementById('userFullName').value = user.name;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole2').value = user.role;
            document.getElementById('userStatus').value = user.status;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('userFormBtn').textContent = 'Update';
        }

        function deleteUser(id) {
            if (currentUser?.id === id) { alert('Tidak dapat menghapus akun yang sedang digunakan!'); return; }
            if (confirm('Hapus user ini?')) {
                users = users.filter(u => u.id !== id);
                localStorage.setItem('simpatdaUsers', JSON.stringify(users));
                showToast('User berhasil dihapus!');
                renderUserTable();
            }
        }

        function filterUsers() {
            const search = document.getElementById('searchUser').value.toLowerCase();
            const role = document.getElementById('filterRole').value;
            let filtered = users;
            if (role) filtered = filtered.filter(u => u.role === role);
            if (search) filtered = filtered.filter(u => u.name.toLowerCase().includes(search) || u.username.includes(search));
            renderUserTable(filtered);
        }

        // ============= UTILITY =============
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Close modals on outside click
        ['detailModal', 'mapModal', 'viewMapModal'].forEach(id => {
            document.getElementById(id).addEventListener('click', function(e) {
                if (e.target === this) {
                    if (id === 'detailModal') closeModal();
                    else if (id === 'mapModal') closeMapModal();
                    else closeViewMapModal();
                }
            });
        });

        // ============= FIREBASE FUNCTIONS =============
        function loadFirebaseConfig() {
            const config = JSON.parse(localStorage.getItem('firebaseConfig'));
            if (config) {
                document.getElementById('fbApiKey').value = config.apiKey || '';
                document.getElementById('fbAuthDomain').value = config.authDomain || '';
                document.getElementById('fbDatabaseURL').value = config.databaseURL || '';
                document.getElementById('fbProjectId').value = config.projectId || '';
                document.getElementById('fbStorageBucket').value = config.storageBucket || '';
                document.getElementById('fbAppId').value = config.appId || '';
                
                // Auto connect if config exists
                initFirebase(config);
            }
        }

        function saveFirebaseConfig(event) {
            event.preventDefault();
            
            const config = {
                apiKey: document.getElementById('fbApiKey').value,
                authDomain: document.getElementById('fbAuthDomain').value,
                databaseURL: document.getElementById('fbDatabaseURL').value,
                projectId: document.getElementById('fbProjectId').value,
                storageBucket: document.getElementById('fbStorageBucket').value,
                appId: document.getElementById('fbAppId').value
            };
            
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            initFirebase(config);
        }

        function initFirebase(config) {
            try {
                // Check if Firebase is already initialized
                if (firebaseApp) {
                    firebaseApp.delete().then(() => {
                        connectToFirebase(config);
                    });
                } else {
                    connectToFirebase(config);
                }
            } catch (error) {
                console.error('Firebase init error:', error);
                updateFirebaseStatus(false, error.message);
            }
        }

        function connectToFirebase(config) {
            try {
                firebaseApp = firebase.initializeApp(config);
                firebaseDB = firebase.database();
                
                // Test connection
                firebaseDB.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        firebaseConnected = true;
                        updateFirebaseStatus(true);
                        updateCloudDataCount();
                        addSyncLog('✓ Terhubung ke Firebase');
                        
                        // Enable realtime if set
                        if (document.getElementById('realtimeSync')?.checked) {
                            enableRealtimeSync();
                        }
                    } else {
                        firebaseConnected = false;
                        updateFirebaseStatus(false, 'Koneksi terputus');
                    }
                });
                
            } catch (error) {
                console.error('Firebase connection error:', error);
                updateFirebaseStatus(false, error.message);
            }
        }

        function disconnectFirebase() {
            if (confirm('Putuskan koneksi Firebase?')) {
                if (realtimeListener) {
                    firebaseDB.ref('wajibPajak').off('value', realtimeListener);
                    realtimeListener = null;
                }
                
                if (firebaseApp) {
                    firebaseApp.delete();
                    firebaseApp = null;
                    firebaseDB = null;
                }
                
                firebaseConnected = false;
                localStorage.removeItem('firebaseConfig');
                
                document.getElementById('firebaseConfigForm').reset();
                updateFirebaseStatus(false);
                document.getElementById('cloudDataCount').textContent = '-';
                
                addSyncLog('✗ Koneksi Firebase diputus');
                showToast('Koneksi Firebase diputus');
            }
        }

        function updateFirebaseStatus(connected, error = null) {
            const statusDiv = document.getElementById('firebaseStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusDesc = document.getElementById('statusDesc');
            
            if (connected) {
                statusDiv.className = 'mb-6 p-4 rounded-lg bg-green-100 border border-green-300';
                statusIcon.className = 'w-10 h-10 bg-green-500 rounded-full flex items-center justify-center';
                statusIcon.innerHTML = '<i class="fas fa-check text-white"></i>';
                statusText.textContent = 'Terhubung';
                statusText.className = 'font-medium text-green-800';
                statusDesc.textContent = 'Firebase Realtime Database aktif';
                statusDesc.className = 'text-sm text-green-600';
            } else {
                statusDiv.className = 'mb-6 p-4 rounded-lg bg-red-100 border border-red-300';
                statusIcon.className = 'w-10 h-10 bg-red-500 rounded-full flex items-center justify-center';
                statusIcon.innerHTML = '<i class="fas fa-times text-white"></i>';
                statusText.textContent = 'Tidak Terhubung';
                statusText.className = 'font-medium text-red-800';
                statusDesc.textContent = error || 'Konfigurasi Firebase diperlukan';
                statusDesc.className = 'text-sm text-red-600';
            }
        }

        function updateLocalDataCount() {
            const el = document.getElementById('localDataCount');
            if (el) el.textContent = wajibPajakData.length;
        }

        async function updateCloudDataCount() {
            if (!firebaseConnected || !firebaseDB) {
                document.getElementById('cloudDataCount').textContent = '-';
                return;
            }
            
            try {
                const snapshot = await firebaseDB.ref('wajibPajak').once('value');
                const data = snapshot.val();
                const count = data ? Object.keys(data).length : 0;
                document.getElementById('cloudDataCount').textContent = count;
            } catch (error) {
                console.error('Error getting cloud count:', error);
                document.getElementById('cloudDataCount').textContent = 'Error';
            }
        }

        function updateCloudStatus() {
            updateLocalDataCount();
            if (firebaseConnected) {
                updateCloudDataCount();
            }
        }

        async function uploadToCloud() {
            if (!firebaseConnected || !firebaseDB) {
                showToast('Firebase belum terhubung!');
                return;
            }
            
            const btn = document.getElementById('btnUpload');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengupload...';
            
            try {
                addSyncLog('⏳ Memulai upload data ke cloud...');
                
                // Upload wajib pajak data
                const wpRef = firebaseDB.ref('wajibPajak');
                for (const wp of wajibPajakData) {
                    await wpRef.child(wp.id.toString()).set(wp);
                }
                addSyncLog(`✓ ${wajibPajakData.length} data wajib pajak diupload`);
                
                // Upload users data
                const usersRef = firebaseDB.ref('users');
                for (const user of users) {
                    await usersRef.child(user.id.toString()).set(user);
                }
                addSyncLog(`✓ ${users.length} data user diupload`);
                
                // Upload map layers metadata
                const layersRef = firebaseDB.ref('mapLayers');
                await layersRef.set(mapLayers);
                addSyncLog(`✓ ${mapLayers.length} layer peta diupload`);
                
                await updateCloudDataCount();
                showToast('Data berhasil diupload ke cloud!');
                addSyncLog('✓ Upload selesai');
                
            } catch (error) {
                console.error('Upload error:', error);
                addSyncLog('✗ Error: ' + error.message);
                showToast('Gagal upload: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload ke Cloud';
            }
        }

        async function downloadFromCloud() {
            if (!firebaseConnected || !firebaseDB) {
                showToast('Firebase belum terhubung!');
                return;
            }
            
            if (!confirm('Download akan menimpa data lokal. Lanjutkan?')) return;
            
            const btn = document.getElementById('btnDownload');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendownload...';
            
            try {
                addSyncLog('⏳ Memulai download data dari cloud...');
                
                // Download wajib pajak data
                const wpSnapshot = await firebaseDB.ref('wajibPajak').once('value');
                const wpData = wpSnapshot.val();
                if (wpData) {
                    wajibPajakData = Object.values(wpData);
                    localStorage.setItem('wajibPajakData', JSON.stringify(wajibPajakData));
                    addSyncLog(`✓ ${wajibPajakData.length} data wajib pajak didownload`);
                } else {
                    addSyncLog('ℹ Tidak ada data wajib pajak di cloud');
                }
                
                // Download users data
                const usersSnapshot = await firebaseDB.ref('users').once('value');
                const usersData = usersSnapshot.val();
                if (usersData) {
                    users = Object.values(usersData);
                    localStorage.setItem('simpatdaUsers', JSON.stringify(users));
                    addSyncLog(`✓ ${users.length} data user didownload`);
                }
                
                // Download map layers
                const layersSnapshot = await firebaseDB.ref('mapLayers').once('value');
                const layersData = layersSnapshot.val();
                if (layersData) {
                    mapLayers = layersData;
                    localStorage.setItem('mapLayers', JSON.stringify(mapLayers));
                    addSyncLog(`✓ ${mapLayers.length} layer peta didownload`);
                }
                
                updateLocalDataCount();
                updateDashboard();
                renderTable();
                
                showToast('Data berhasil didownload dari cloud!');
                addSyncLog('✓ Download selesai');
                
            } catch (error) {
                console.error('Download error:', error);
                addSyncLog('✗ Error: ' + error.message);
                showToast('Gagal download: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Download dari Cloud';
            }
        }

        async function syncData() {
            if (!firebaseConnected || !firebaseDB) {
                showToast('Firebase belum terhubung!');
                return;
            }
            
            const btn = document.getElementById('btnSync');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyinkronkan...';
            
            try {
                addSyncLog('⏳ Memulai sinkronisasi 2 arah...');
                
                // Get cloud data
                const wpSnapshot = await firebaseDB.ref('wajibPajak').once('value');
                const cloudData = wpSnapshot.val() ? Object.values(wpSnapshot.val()) : [];
                
                // Merge data (newer wins)
                const mergedData = mergeData(wajibPajakData, cloudData);
                
                addSyncLog(`ℹ Lokal: ${wajibPajakData.length}, Cloud: ${cloudData.length}, Merged: ${mergedData.length}`);
                
                // Update local
                wajibPajakData = mergedData;
                localStorage.setItem('wajibPajakData', JSON.stringify(wajibPajakData));
                
                // Update cloud
                const wpRef = firebaseDB.ref('wajibPajak');
                await wpRef.remove();
                for (const wp of mergedData) {
                    await wpRef.child(wp.id.toString()).set(wp);
                }
                
                // Sync users
                const usersSnapshot = await firebaseDB.ref('users').once('value');
                const cloudUsers = usersSnapshot.val() ? Object.values(usersSnapshot.val()) : [];
                const mergedUsers = mergeData(users, cloudUsers);
                users = mergedUsers;
                localStorage.setItem('simpatdaUsers', JSON.stringify(users));
                
                const usersRef = firebaseDB.ref('users');
                await usersRef.remove();
                for (const user of mergedUsers) {
                    await usersRef.child(user.id.toString()).set(user);
                }
                
                updateLocalDataCount();
                await updateCloudDataCount();
                updateDashboard();
                renderTable();
                
                showToast('Sinkronisasi berhasil!');
                addSyncLog('✓ Sinkronisasi selesai');
                
            } catch (error) {
                console.error('Sync error:', error);
                addSyncLog('✗ Error: ' + error.message);
                showToast('Gagal sinkronisasi: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Sinkronkan (2 Arah)';
            }
        }

        function mergeData(localData, cloudData) {
            const merged = new Map();
            
            // Add local data
            localData.forEach(item => {
                merged.set(item.id, item);
            });
            
            // Merge with cloud data (newer wins based on createdAt or updatedAt)
            cloudData.forEach(item => {
                const existing = merged.get(item.id);
                if (!existing) {
                    merged.set(item.id, item);
                } else {
                    // Compare dates, newer wins
                    const existingDate = new Date(existing.updatedAt || existing.createdAt);
                    const newDate = new Date(item.updatedAt || item.createdAt);
                    if (newDate > existingDate) {
                        merged.set(item.id, item);
                    }
                }
            });
            
            return Array.from(merged.values());
        }

        function enableRealtimeSync() {
            if (!firebaseConnected || !firebaseDB) return;
            
            // Remove existing listener
            if (realtimeListener) {
                firebaseDB.ref('wajibPajak').off('value', realtimeListener);
            }
            
            // Add new listener
            realtimeListener = firebaseDB.ref('wajibPajak').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const cloudData = Object.values(data);
                    // Only update if cloud has more data or different data
                    if (cloudData.length !== wajibPajakData.length) {
                        wajibPajakData = cloudData;
                        localStorage.setItem('wajibPajakData', JSON.stringify(wajibPajakData));
                        updateDashboard();
                        updateLocalDataCount();
                        addSyncLog('⚡ Realtime sync: Data diperbarui');
                    }
                }
            });
            
            addSyncLog('⚡ Realtime sync diaktifkan');
        }

        function disableRealtimeSync() {
            if (realtimeListener && firebaseDB) {
                firebaseDB.ref('wajibPajak').off('value', realtimeListener);
                realtimeListener = null;
                addSyncLog('⚡ Realtime sync dinonaktifkan');
            }
        }

        function toggleRealtimeSync() {
            const enabled = document.getElementById('realtimeSync').checked;
            if (enabled) {
                enableRealtimeSync();
            } else {
                disableRealtimeSync();
            }
            saveAutoSyncSettings();
        }

        function saveAutoSyncSettings() {
            const settings = {
                autoSyncSave: document.getElementById('autoSyncSave')?.checked || false,
                realtimeSync: document.getElementById('realtimeSync')?.checked || false
            };
            localStorage.setItem('autoSyncSettings', JSON.stringify(settings));
        }

        function loadAutoSyncSettings() {
            const settings = JSON.parse(localStorage.getItem('autoSyncSettings')) || {};
            if (document.getElementById('autoSyncSave')) {
                document.getElementById('autoSyncSave').checked = settings.autoSyncSave || false;
            }
            if (document.getElementById('realtimeSync')) {
                document.getElementById('realtimeSync').checked = settings.realtimeSync || false;
            }
        }

        function addSyncLog(message) {
            const logDiv = document.getElementById('syncLog');
            if (!logDiv) return;
            
            logDiv.classList.remove('hidden');
            const time = new Date().toLocaleTimeString('id-ID');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${time}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Keep only last 20 logs
            while (logDiv.children.length > 20) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }

        // Auto-sync when saving data
        async function autoSyncAfterSave() {
            const settings = JSON.parse(localStorage.getItem('autoSyncSettings')) || {};
            if (settings.autoSyncSave && firebaseConnected && firebaseDB) {
                try {
                    const wpRef = firebaseDB.ref('wajibPajak');
                    const latestWP = wajibPajakData[wajibPajakData.length - 1];
                    await wpRef.child(latestWP.id.toString()).set(latestWP);
                    console.log('Auto-synced to cloud');
                } catch (error) {
                    console.error('Auto-sync error:', error);
                }
            }
        }

        // ============= REALISASI PAJAK FUNCTIONS =============
        let realisasiData = JSON.parse(localStorage.getItem('realisasiData')) || [];
        let realisasiChart = null;
        let komposisiChart = null;
        
        const bulanNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const bulanShort = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];

        function showInputRealisasiModal(editId = null) {
            document.getElementById('realisasiModal').classList.remove('hidden');
            document.getElementById('realisasiForm').reset();
            document.getElementById('editRealisasiId').value = '';
            document.getElementById('realisasiModalTitle').textContent = 'Input Target & Realisasi';
            document.getElementById('inputCapaian').textContent = '0%';
            document.getElementById('inputProgressBar').style.width = '0%';
            
            // Set current date and month
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            document.getElementById('inputTanggal').value = todayStr;
            document.getElementById('inputTanggalSetor').value = '';
            document.getElementById('inputTahun').value = now.getFullYear();
            document.getElementById('inputBulan').value = now.getMonth() + 1;
            
            if (editId) {
                const data = realisasiData.find(r => r.id === editId);
                if (data) {
                    document.getElementById('editRealisasiId').value = data.id;
                    document.getElementById('realisasiModalTitle').textContent = 'Edit Realisasi';
                    document.getElementById('inputTanggal').value = data.tanggalInput || todayStr;
                    document.getElementById('inputTanggalSetor').value = data.tanggalSetor || '';
                    document.getElementById('inputTahun').value = data.tahun;
                    document.getElementById('inputBulan').value = data.bulan;
                    document.getElementById('inputJenisPajak').value = data.jenisPajak;
                    document.getElementById('inputTarget').value = new Intl.NumberFormat('id-ID').format(data.target);
                    document.getElementById('inputRealisasiNominal').value = new Intl.NumberFormat('id-ID').format(data.realisasi);
                    document.getElementById('inputKeterangan').value = data.keterangan || '';
                    hitungCapaianInput();
                }
            }
        }

        function closeRealisasiModal() {
            document.getElementById('realisasiModal').classList.add('hidden');
        }

        function formatRupiahInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = new Intl.NumberFormat('id-ID').format(value);
            }
        }

        function hitungCapaianInput() {
            const target = parseRupiah(document.getElementById('inputTarget').value);
            const realisasi = parseRupiah(document.getElementById('inputRealisasiNominal').value);
            const capaian = target > 0 ? (realisasi / target * 100) : 0;
            
            document.getElementById('inputCapaian').textContent = capaian.toFixed(2) + '%';
            document.getElementById('inputProgressBar').style.width = Math.min(capaian, 100) + '%';
            
            // Update color based on capaian
            const bar = document.getElementById('inputProgressBar');
            bar.classList.remove('bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-600');
            if (capaian >= 100) bar.classList.add('bg-green-500');
            else if (capaian >= 75) bar.classList.add('bg-blue-600');
            else if (capaian >= 50) bar.classList.add('bg-yellow-500');
            else bar.classList.add('bg-red-500');
        }

        function saveRealisasi(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editRealisasiId').value;
            const tanggalInput = document.getElementById('inputTanggal').value;
            const tanggalSetor = document.getElementById('inputTanggalSetor').value;
            const tahun = parseInt(document.getElementById('inputTahun').value);
            const bulan = parseInt(document.getElementById('inputBulan').value);
            const jenisPajak = document.getElementById('inputJenisPajak').value;
            const target = parseRupiah(document.getElementById('inputTarget').value);
            const realisasi = parseRupiah(document.getElementById('inputRealisasiNominal').value);
            const keterangan = document.getElementById('inputKeterangan').value;
            
            if (editId) {
                // Update existing
                const idx = realisasiData.findIndex(r => r.id === parseInt(editId));
                if (idx !== -1) {
                    realisasiData[idx] = {
                        ...realisasiData[idx],
                        tanggalInput, tanggalSetor, tahun, bulan, jenisPajak, target, realisasi, keterangan,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Check for duplicate
                const existing = realisasiData.find(r => 
                    r.tahun === tahun && r.bulan === bulan && r.jenisPajak === jenisPajak
                );
                
                if (existing) {
                    if (!confirm('Data untuk periode dan jenis pajak ini sudah ada. Ganti dengan data baru?')) {
                        return;
                    }
                    const idx = realisasiData.indexOf(existing);
                    realisasiData[idx] = {
                        ...existing,
                        tanggalInput, tanggalSetor, target, realisasi, keterangan,
                        updatedAt: new Date().toISOString()
                    };
                } else {
                    realisasiData.push({
                        id: Date.now(),
                        tanggalInput, tanggalSetor, tahun, bulan, jenisPajak, target, realisasi, keterangan,
                        createdAt: new Date().toISOString()
                    });
                }
            }
            
            localStorage.setItem('realisasiData', JSON.stringify(realisasiData));
            closeRealisasiModal();
            loadRealisasi();
            showToast('Data realisasi berhasil disimpan!');
        }

        function loadRealisasi() {
            // Set default tahun to current year if empty
            const tahunInput = document.getElementById('realisasiTahun');
            if (!tahunInput.value) {
                tahunInput.value = new Date().getFullYear();
            }
            const tahun = parseInt(tahunInput.value);
            const bulan = document.getElementById('realisasiBulan').value;
            
            // Filter data by year and optionally by month
            let filteredData = realisasiData.filter(r => r.tahun === tahun);
            if (bulan) {
                filteredData = filteredData.filter(r => r.bulan === parseInt(bulan));
            }
            
            // Calculate totals per tax type
            const taxTotals = {};
            Object.keys(taxTypes).forEach(key => {
                taxTotals[key] = { target: 0, realisasi: 0 };
            });
            
            filteredData.forEach(r => {
                if (taxTotals[r.jenisPajak]) {
                    taxTotals[r.jenisPajak].target += r.target;
                    taxTotals[r.jenisPajak].realisasi += r.realisasi;
                }
            });
            
            // Calculate grand totals
            let grandTarget = 0;
            let grandRealisasi = 0;
            Object.values(taxTotals).forEach(t => {
                grandTarget += t.target;
                grandRealisasi += t.realisasi;
            });
            
            const grandCapaian = grandTarget > 0 ? (grandRealisasi / grandTarget * 100) : 0;
            
            // Update summary cards
            document.getElementById('totalTarget').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(grandTarget);
            document.getElementById('totalRealisasi').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(grandRealisasi);
            document.getElementById('persenCapaian').textContent = grandCapaian.toFixed(1) + '%';
            document.getElementById('progressCapaian').style.width = Math.min(grandCapaian, 100) + '%';
            document.getElementById('tahunTarget').textContent = tahun;
            document.getElementById('periodeRealisasi').textContent = bulan ? bulanNames[parseInt(bulan)] + ' ' + tahun : 'Desember ' + tahun;
            
            // Render table
            renderRealisasiTable(taxTotals, grandTarget, grandRealisasi);
            
            // Render monthly table
            renderMonthlyTable(tahun);
            
            // Render charts
            renderRealisasiChart(taxTotals);
            renderKomposisiChart(taxTotals);
        }

        function renderRealisasiTable(taxTotals, grandTarget, grandRealisasi) {
            const tbody = document.getElementById('realisasiTableBody');
            const tahun = parseInt(document.getElementById('realisasiTahun').value);
            const bulan = document.getElementById('realisasiBulan').value;
            let rows = '';
            let no = 1;
            
            Object.keys(taxTypes).forEach(key => {
                const data = taxTotals[key];
                const selisih = data.realisasi - data.target;
                const capaian = data.target > 0 ? (data.realisasi / data.target * 100) : 0;
                
                // Get latest record for this tax type to show date
                let filteredRecords = realisasiData.filter(r => r.tahun === tahun && r.jenisPajak === key);
                if (bulan) {
                    filteredRecords = filteredRecords.filter(r => r.bulan === parseInt(bulan));
                }
                const latestRecord = filteredRecords.sort((a, b) => new Date(b.tanggalInput || b.createdAt) - new Date(a.tanggalInput || a.createdAt))[0];
                
                let tanggalDisplay = '-';
                let tanggalSetorDisplay = '';
                if (latestRecord) {
                    if (latestRecord.tanggalInput) {
                        const tglInput = new Date(latestRecord.tanggalInput);
                        tanggalDisplay = tglInput.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
                    }
                    if (latestRecord.tanggalSetor) {
                        const tglSetor = new Date(latestRecord.tanggalSetor);
                        tanggalSetorDisplay = `<span class="text-xs text-gray-400 block">Setor: ${tglSetor.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' })}</span>`;
                    }
                }
                
                let progressColor = 'bg-gray-200';
                let textColor = 'text-gray-600';
                if (capaian >= 100) { progressColor = 'bg-green-500'; textColor = 'text-green-600'; }
                else if (capaian >= 75) { progressColor = 'bg-blue-500'; textColor = 'text-blue-600'; }
                else if (capaian >= 50) { progressColor = 'bg-yellow-500'; textColor = 'text-yellow-600'; }
                else if (capaian > 0) { progressColor = 'bg-red-500'; textColor = 'text-red-600'; }
                
                rows += `
                    <tr class="table-row border-b hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${no++}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas ${taxTypes[key].icon} text-${taxTypes[key].color}-500"></i>
                                ${taxTypes[key].name}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="text-xs">${tanggalDisplay}</span>
                            ${tanggalSetorDisplay}
                        </td>
                        <td class="px-4 py-3 text-sm text-right">${new Intl.NumberFormat('id-ID').format(data.target)}</td>
                        <td class="px-4 py-3 text-sm text-right font-medium">${new Intl.NumberFormat('id-ID').format(data.realisasi)}</td>
                        <td class="px-4 py-3 text-sm text-right ${selisih >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${selisih >= 0 ? '+' : ''}${new Intl.NumberFormat('id-ID').format(selisih)}
                        </td>
                        <td class="px-4 py-3 text-sm text-center font-semibold ${textColor}">${capaian.toFixed(1)}%</td>
                        <td class="px-4 py-3">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${progressColor} h-2 rounded-full transition-all duration-300" style="width: ${Math.min(capaian, 100)}%"></div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="editRealisasiByTax('${key}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows;
            
            // Update footer
            const grandCapaian = grandTarget > 0 ? (grandRealisasi / grandTarget * 100) : 0;
            const grandSelisih = grandRealisasi - grandTarget;
            document.getElementById('footerTarget').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(grandTarget);
            document.getElementById('footerRealisasi').textContent = 'Rp ' + new Intl.NumberFormat('id-ID').format(grandRealisasi);
            document.getElementById('footerSelisih').textContent = (grandSelisih >= 0 ? '+' : '') + 'Rp ' + new Intl.NumberFormat('id-ID').format(grandSelisih);
            document.getElementById('footerCapaian').textContent = grandCapaian.toFixed(1) + '%';
        }

        function renderMonthlyTable(tahun) {
            const tbody = document.getElementById('monthlyTableBody');
            let rows = '';
            
            Object.keys(taxTypes).forEach(key => {
                let rowTotal = 0;
                let cells = `<td class="px-3 py-2 text-sm font-medium">${taxTypes[key].name}</td>`;
                
                for (let m = 1; m <= 12; m++) {
                    const data = realisasiData.find(r => r.tahun === tahun && r.bulan === m && r.jenisPajak === key);
                    const value = data ? data.realisasi : 0;
                    rowTotal += value;
                    cells += `<td class="px-3 py-2 text-xs text-right ${value > 0 ? '' : 'text-gray-300'}">${value > 0 ? formatJuta(value) : '-'}</td>`;
                }
                
                cells += `<td class="px-3 py-2 text-xs text-right font-semibold bg-blue-50">${formatJuta(rowTotal)}</td>`;
                rows += `<tr class="border-b hover:bg-gray-50">${cells}</tr>`;
            });
            
            tbody.innerHTML = rows;
        }

        function formatJuta(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(1) + 'M';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'Jt';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + 'Rb';
            }
            return value.toString();
        }

        function renderRealisasiChart(taxTotals) {
            const ctx = document.getElementById('realisasiChart').getContext('2d');
            
            if (realisasiChart) {
                realisasiChart.destroy();
            }
            
            const labels = Object.keys(taxTypes).map(k => taxTypes[k].name.replace('Pajak ', '').replace('PBJT ', ''));
            const targetData = Object.keys(taxTypes).map(k => taxTotals[k].target);
            const realisasiDataArr = Object.keys(taxTypes).map(k => taxTotals[k].realisasi);
            
            realisasiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Target',
                            data: targetData,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        },
                        {
                            label: 'Realisasi',
                            data: realisasiDataArr,
                            backgroundColor: 'rgba(34, 197, 94, 0.5)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatJuta(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderKomposisiChart(taxTotals) {
            const ctx = document.getElementById('komposisiChart').getContext('2d');
            
            if (komposisiChart) {
                komposisiChart.destroy();
            }
            
            const labels = [];
            const data = [];
            const colors = [
                '#3b82f6', '#ef4444', '#22c55e', '#f59e0b', '#8b5cf6', 
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#a855f7', '#eab308'
            ];
            
            Object.keys(taxTypes).forEach((k, i) => {
                if (taxTotals[k].realisasi > 0) {
                    labels.push(taxTypes[k].name.replace('Pajak ', '').replace('PBJT ', ''));
                    data.push(taxTotals[k].realisasi);
                }
            });
            
            komposisiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { size: 10 },
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const persen = ((value / total) * 100).toFixed(1);
                                    return `Rp ${new Intl.NumberFormat('id-ID').format(value)} (${persen}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function editRealisasiByTax(jenisPajak) {
            const tahun = parseInt(document.getElementById('realisasiTahun').value);
            const bulan = document.getElementById('realisasiBulan').value;
            
            // Find the first record for this tax type
            const data = realisasiData.find(r => 
                r.tahun === tahun && 
                r.jenisPajak === jenisPajak &&
                (!bulan || r.bulan === parseInt(bulan))
            );
            
            if (data) {
                showInputRealisasiModal(data.id);
            } else {
                showInputRealisasiModal();
                document.getElementById('inputJenisPajak').value = jenisPajak;
            }
        }

        function deleteRealisasi(id) {
            if (confirm('Hapus data realisasi ini?')) {
                realisasiData = realisasiData.filter(r => r.id !== id);
                localStorage.setItem('realisasiData', JSON.stringify(realisasiData));
                loadRealisasi();
                showToast('Data realisasi berhasil dihapus!');
            }
        }

        function exportRealisasi() {
            const tahun = document.getElementById('realisasiTahun').value;
            const headers = ['No', 'Jenis Pajak', 'Tanggal Input', 'Tanggal Setor', 'Bulan', 'Target', 'Realisasi', 'Selisih', 'Capaian (%)', 'Keterangan'];
            let csv = headers.join(',') + '\n';
            
            let no = 1;
            Object.keys(taxTypes).forEach(key => {
                const yearData = realisasiData.filter(r => r.tahun === parseInt(tahun) && r.jenisPajak === key);
                const target = yearData.reduce((sum, r) => sum + r.target, 0);
                const realisasi = yearData.reduce((sum, r) => sum + r.realisasi, 0);
                const selisih = realisasi - target;
                const capaian = target > 0 ? (realisasi / target * 100).toFixed(2) : 0;
                
                // Get latest record for date info
                const latestRecord = yearData.sort((a, b) => new Date(b.tanggalInput || b.createdAt) - new Date(a.tanggalInput || a.createdAt))[0];
                const tanggalInput = latestRecord?.tanggalInput || '-';
                const tanggalSetor = latestRecord?.tanggalSetor || '-';
                const bulanStr = latestRecord ? bulanNames[latestRecord.bulan] : '-';
                const keterangan = latestRecord?.keterangan || '';
                
                csv += [no++, `"${taxTypes[key].name}"`, tanggalInput, tanggalSetor, bulanStr, target, realisasi, selisih, capaian, `"${keterangan}"`].join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `realisasi_pajak_sidrap_${tahun}.csv`;
            link.click();
            showToast('Data realisasi berhasil diekspor!');
        }

        // Close realisasi modal on outside click
        document.getElementById('realisasiModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeRealisasiModal();
        });
    </script>
</body>
</html>